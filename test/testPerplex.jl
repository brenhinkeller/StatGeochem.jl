## -- Perplex name abbreviations

    abbreviations = ("ak", "alm", "and", "andr", "chum", "cz", "crd", "ep", "fa", "fctd", "fcrd", "fep", "fosm", "fst", "fo", "geh", "gr", "hcrd", "tpz", "ky", "larn", "law", "merw", "mctd", "mst", "mnctd", "mncrd", "mnst", "mont", "osm1", "osm2", "phA", "pump", "py", "rnk", "sill", "spss", "sph", "spu", "teph", "ty", "vsv", "zrc", "zo", "acm", "cats", "di", "en", "fs", "hed", "jd", "mgts", "pswo", "pxmn", "rhod", "wo", "anth", "cumm", "fanth", "fgl", "ftr", "ged", "gl", "grun", "parg", "rieb", "tr", "ts", "deer", "fcar", "fspr", "mcar", "spr4", "spr7", "ann", "cel", "east", "fcel", "ma", "mnbi", "mu", "naph", "pa", "phl", "afchl", "ames", "clin", "daph", "fsud", "mnchl", "sud", "atg", "chr", "fta", "kao", "pre", "prl", "ta", "tats", "ab", "anl", "an", "coe", "crst", "heu", "abh", "kals", "lmt", "lc", "me", "mic", "ne", "q", "san", "stlb", "stv", "trd", "wrk", "bdy", "cor", "geik", "hem", "herc", "ilm", "oilm", "lime", "mft", "mt", "mang", "bunsn", "per", "pnt", "ru", "sp", "usp", "br", "dsp", "gth", "ank", "arag", "cc", "dol", "mag", "rhc", "sid", "diam", "gph", "iron", "Ni", "CO2", "CO", "H2", "CH4", "O2", "H2O", "abL", "anL", "diL", "enL", "faL", "fliq", "foL", "h2oL", "hliq", "kspL", "mliq", "qL", "silL", "H+", "Cl-", "OH-", "Na+", "K+", "Ca++", "Mg++", "Fe++", "Al+++", "CO3", "AlOH3", "AlOH4-", "KOH", "HCL", "KCL", "NaCl", "CaCl2", "CaCl+", "MgCl2", "MgCl", "FeCl2", "aqSi", "Augite(G)", "Cpx(JH)", "Cpx(l)", "Cpx(h)", "Cpx(stx)", "Cpx(stx7)", "Omph(HP)", "Cpx(HP)", "Cpx(m)", "Cpx(stx8)", "Omph(GHP)", "cAmph(G)", "Cumm", "Gl", "Tr", "GlTrTsPg", "Amph(DHP)", "Amph(DPW)", "Ca-Amph(D)", "Na-Amph(D)", "Act(M)", "GlTrTsMr", "cAmph(DP)", "melt(G)", "melt(W)", "melt(HP)", "melt(HGP)", "pMELTS(G)", "mMELTS(G)", "LIQ(NK)", "LIQ(EF)", "Chl(W)", "Chl(HP)", "Chl(LWV)", "O(JH)", "O(SG)", "O(HP)", "O(HPK)", "O(stx)", "O(stx7)", "Ol(m)", "O(stx8)", "Sp(JH)", "GaHcSp", "Sp(JR)", "Sp(GS)", "Sp(HP)", "Sp(stx)", "CrSp", "Sp(stx7)", "Sp(WPC)", "Sp(stx8)", "Pl(JH)", "Pl(h)", "Pl(stx8)", "Kf", "San", "San(TH)", "Grt(JH)", "Gt(W)", "CrGt", "Gt(MPF)", "Gt(B)", "Gt(GCT)", "Gt(HP)", "Gt(EWHP)", "Gt(WPH)", "Gt(stx)", "Gt(stx8)", "Gt(WPPH)", "ZrGt(KP)", "Maj", "Opx(JH)", "Opx(W)", "Opx(HP)", "CrOpx(HP)", "Opx(stx)", "Opx(stx8)", "Mica(W)", "Pheng(HP)", "MaPa", "Mica(CF)", "Mica(CHA1)", "Mica(CHA)", "Mica+(CHA)", "Mica(M)", "Mica(SGH)", "Ctd(W)", "Ctd(HP)", "Ctd(SGH)", "St(W)", "St(HP)", "Bi(W)", "Bio(TCC)", "Bio(WPH)", "Bio(HP)", "Crd(W)", "hCrd", "Sa(WP)", "Sapp(HP)", "Sapp(KWP)", "Sapp(TP)", "Osm(HP)", "F", "F(salt)", "COH-Fluid", "Aq_solven0", "WADDAH", "T", "Scap", "Carp", "Carp(M)", "Carp(SGH)", "Sud(Livi)", "Sud", "Sud(M)", "Anth", "o-Amph", "oAmph(DP)", "feldspar", "feldspar_B", "Pl(I1,HP)", "Fsp(C1)", "Do(HP)", "M(HP)", "Do(AE)", "Cc(AE)", "oCcM(HP)", "Carb(M)", "oCcM(EF)", "dis(EF)", "IlHm(A)", "IlGkPy", "Ilm(WPH)", "Ilm(WPH0)", "Neph(FB)", "Chum", "Atg(PN)", "B", "Pu(M)", "Stlp(M)", "Wus",)
    common_names = ("akermanite", "almandine", "andalusite", "andradite", "clinohumite", "clinozoisite", "cordierite", "epidote", "fayalite", "Fe-chloritoid", "Fe-cordierite", "Fe-epidote", "Fe-osumilite", "Fe-staurolite", "forsterite", "gehlenite", "grossular", "hydrous cordierite", "hydroxy-topaz", "kyanite", "larnite", "lawsonite", "merwinite", "Mg-chloritoid", "Mg-staurolite", "Mn-chloritoid", "Mn-cordierite", "Mn-staurolite", "monticellite", "osumilite(1)", "osumilite(2)", "phase A", "pumpellyite", "pyrope", "rankinite", "sillimanite", "spessartine", "sphene", "spurrite", "tephroite", "tilleyite", "vesuvianite", "zircon", "zoisite", "acmite", "Ca-tschermakite", "diopside", "enstatite", "ferrosilite", "hedenbergite", "jadeite", "Mg-tschermakite", "pseudowollastonite", "pyroxmangite", "rhodonite", "wollastonite", "anthophyllite", "cummingtonite", "Fe-anthophyllite", "Fe-glaucophane", "ferroactinolite", "gedrite", "glaucophane", "grunerite", "pargasite", "riebeckite", "tremolite", "tschermakite", "deerite", "Fe-carpholite", "Fe-sapphirine(793)", "Mg-carpholite", "sapphirine(442)", "sapphirine(793)", "annite", "celadonite", "eastonite", "Fe-celadonite", "margarite", "Mn-biotite", "muscovite", "Na-phlogopite", "paragonite", "phlogopite", "Al-free chlorite", "amesite", "clinochlore", "daphnite", "Fe-sudoite", "Mn-chlorite", "sudoite", "antigorite", "chrysotile", "Fe-talc", "kaolinite", "prehnite", "pyrophyllite", "talc", "tschermak-talc", "albite", "analcite", "anorthite", "coesite", "cristobalite", "heulandite", "highalbite", "kalsilite", "laumontite", "leucite", "meionite", "microcline", "nepheline", "quartz", "sanidine", "stilbite", "stishovite", "tridymite", "wairakite", "baddeleyite", "corundum", "geikielite", "hematite", "hercynite", "ilmenite", "ilmenite(ordered)", "lime", "magnesioferrite", "magnetite", "manganosite", "nickel oxide", "periclase", "pyrophanite", "rutile", "spinel", "ulvospinel", "brucite", "diaspore", "goethite", "ankerite", "aragonite", "calcite", "dolomite", "magnesite", "rhodochrosite", "siderite", "diamond", "graphite", "iron", "nickel", "carbon dioxide", "carbon monoxide", "hydrogen", "methane", "oxygen", "water fluid", "albite liquid", "anorthite liquid", "diopside liquid", "enstatite liquid", "fayalite liquid", "Fe-liquid (in KFMASH)", "forsterite liquid", "H2O liquid", "H2O liquid (in KFMASH)", "K-feldspar liquid", "Mg liquid (in KFMASH)", "Silica liquid", "Sillimanite liquid", "H+(aq)", "Cl(aq)", "OH(aq)", "Na+(aq)", "K+(aq)", "Ca2+(aq)", "Mg2+(aq)", "Fe2+(aq)", "Al3+(aq)", "CO3--(aq)", "Al(OH)3(aq)", "Al(OH)4----(aq)", "KOH(aq)", "HCl(aq)", "KCl(aq)", "NaCl(aq)", "CaCl(aq)", "CaCl+(aq)", "MgCl2(aq)", "MgCl+(aq)", "FeCl(aq)", "Aqueous silica", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "clinoamphibole", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "chlorite", "chlorite", "chlorite", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "plagioclase", "plagioclase", "plagioclase", "k-feldspar", "k-feldspar", "k-feldspar", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "chloritoid", "chloritoid", "chloritoid", "staurolite", "staurolite", "biotite", "biotite", "biotite", "biotite", "cordierite", "cordierite", "sapphirine", "sapphirine", "sapphirine", "sapphirine", "osumilite", "fluid", "fluid", "fluid", "fluid", "fluid", "talc", "scapolite", "carpholite", "carpholite", "carpholite", "sudoite", "sudoite", "sudoite", "orthoamphibole", "orthoamphibole", "orthoamphibole", "ternary feldspar", "ternary feldspar", "ternary feldspar", "ternary feldspar", "calcite", "calcite", "calcite", "calcite", "calcite", "calcite", "calcite", "calcite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "nepheline", "clinohumite", "serpentine", "brucite", "pumpellyite", "stilpnomelane", "wüstite",)

    @test perplex_common_name.(abbreviations) == common_names

    abbreviations = ("ak", "alm", "and", "andr", "chum", "cz", "crd", "ep", "fa", "fctd", "fcrd", "fep", "fosm", "fst", "fo", "geh", "gr", "hcrd", "tpz", "ky", "larn", "law", "merw", "mctd", "mst", "mnctd", "mncrd", "mnst", "mont", "osm1", "osm2", "phA", "pump", "py", "rnk", "sill", "spss", "sph", "spu", "teph", "ty", "vsv", "zrc", "zo", "acm", "cats", "di", "en", "fs", "hed", "jd", "mgts", "pswo", "pxmn", "rhod", "wo", "anth", "cumm", "fanth", "fgl", "ftr", "ged", "gl", "grun", "parg", "rieb", "tr", "ts", "deer", "fcar", "fspr", "mcar", "spr4", "spr7", "ann", "cel", "east", "fcel", "ma", "mnbi", "mu", "naph", "pa", "phl", "afchl", "ames", "clin", "daph", "fsud", "mnchl", "sud", "atg", "chr", "fta", "kao", "pre", "prl", "ta", "tats", "ab", "anl", "an", "coe", "crst", "heu", "abh", "kals", "lmt", "lc", "me", "mic", "ne", "q", "san", "stlb", "stv", "trd", "wrk", "bdy", "cor", "geik", "hem", "herc", "ilm","oilm","lime", "mft", "mt", "mang", "bunsn", "per", "pnt", "ru", "sp", "usp", "br", "dsp", "gth", "ank", "arag", "cc", "dol", "mag", "rhc", "sid", "diam", "gph", "iron", "Ni", "CO2", "CO", "H2", "CH4", "O2", "H2O", "abL", "anL", "diL", "enL", "faL", "fliq", "foL", "h2oL", "hliq", "kspL", "mliq", "qL", "silL", "H+", "Cl-", "OH-", "Na+", "K+", "Ca++", "Mg++", "Fe++", "Al+++", "CO3", "AlOH3", "AlOH4-", "KOH", "HCL", "KCL", "NaCl", "CaCl2", "CaCl+", "MgCl2", "MgCl", "FeCl2", "aqSi",)
    full_names = ("akermanite", "almandine", "andalusite", "andradite", "clinohumite", "clinozoisite", "cordierite", "epidote(ordered)", "fayalite", "Fe-chloritoid", "Fe-cordierite", "Fe-epidote", "Fe-osumilite", "Fe-staurolite", "forsterite", "gehlenite", "grossular", "hydrous cordierite", "hydroxy-topaz", "kyanite", "larnite-bredigite", "lawsonite", "merwinite", "Mg-chloritoid", "Mg-staurolite", "Mn-chloritoid", "Mn-cordierite", "Mn-staurolite", "monticellite", "osumilite(1)", "osumilite(2)", "phase A", "pumpellyite", "pyrope", "rankinite", "sillimanite", "spessartine", "sphene", "spurrite", "tephroite", "tilleyite", "vesuvianite", "zircon", "zoisite", "acmite", "Ca-tschermaks pyroxene", "Diopside", "enstatite", "ferrosilite", "hedenbergite", "jadeite", "mg-tschermak", "pseudowollastonite", "pyroxmangite", "rhodonite", "wollastonite", "anthophyllite", "cummingtonite", "Fe-anthophyllite", "Fe-glaucophane", "ferroactinolite", "gedrite(Na-free)", "glaucophane", "grunerite", "pargasite", "riebeckite", "tremolite", "tschermakite", "deerite", "fe-carpholite", "fe-sapphirine(793)", "mg-carpholite", "sapphirine(442)", "sapphirine(793)", "annite", "celadonite", "eastonite", "Fe-celadonite", "margarite", "Mn-biotite", "muscovite", "Na-phlogopite", "paragonite", "phlogopite", "Al-free chlorite", "amesite(14Ang)", "clinochlore(ordered)", "daphnite", "Fe-sudoite", "Mn-chlorite", "Sudoite", "antigorite", "chrysotile", "Fe-talc", "Kaolinite", "prehnite", "pyrophyllite", "talc", "tschermak-talc", "albite", "analcite", "anorthite", "coesite", "cristobalite", "heulandite", "highalbite", "kalsilite", "laumontite", "leucite", "meionite", "microcline", "nepheline", "quartz", "sanidine", "stilbite", "stishovite", "tridymite", "wairakite", "baddeleyite", "corundum", "geikielite", "hematite", "hercynite", "ilmenite", "ilmenite(ordered)","lime", "magnesioferrite", "magnetite", "manganosite", "nickel oxide", "periclase", "pyrophanite", "rutile", "spinel", "ulvospinel", "brucite", "diaspore", "goethite", "ankerite", "aragonite", "calcite", "dolomite", "magnesite", "rhodochrosite", "siderite", "diamond", "graphite", "iron", "nickel", "carbon dioxide", "carbon monoxide", "hydrogen", "methane", "oxygen", "water fluid", "albite liquid", "anorthite liquid", "diopside liquid", "enstatite liquid", "fayalite liquid", "Fe-liquid (in KFMASH)", "Forsterite liquid", "H2O liquid", "H2O liquid (in KFMASH)", "K-feldspar liquid", "Mg liquid (in KFMASH)", "Silica liquid", "Sillimanite liquid", "H+(aq)", "Cl(aq)", "OH(aq)", "Na+(aq)", "K+(aq)", "Ca2+(aq)", "Mg2+(aq)", "Fe2+(aq)", "Al3+(aq)", "CO3--(aq)", "Al(OH)3(aq)", "Al(OH)4----(aq)", "KOH(aq)", "HCl(aq)", "KCl(aq)", "NaCl(aq)", "CaCl(aq)", "CaCl+(aq)", "MgCl2(aq)", "MgCl+(aq)", "FeCl(aq)", "Aqueous silica",)

    @test perplex_expand_name.(abbreviations) == full_names
    @test perplex_abbreviate_name.(full_names) == abbreviations
    @test perplex_phase_is_solid.(("melt(HGP)", "q", "diL", "andr", "T(K)")) == (false, true, false, true, false)

    @test findall(germ_perplex_name_matches.(germ_kd["minerals"], germ_kd["minerals"])) == [3, 12, 18]
    @test exp10.(germ_kd["Zircon"]["U"]) ≈ [101.08785935842519, 103.34369845983417, 104.03608480352291, 103.8121056383997, 101.56030582980546, 96.97102808133381, 95.52301023356834, 95.00949287568258, 95.39266897332027, 95.9409467962996, 98.50992762612668, 96.83692718047344, 94.90891312825929, 94.14624435644276, 94.84337501236026, 93.143381367987, 93.420029480108, 93.19958960795938, 91.52189420022472, 90.90693177101275, 91.31581508909859, 90.79564120578124, 90.5492797115014, 90.5874427795424, 89.86632872800187, 88.32832604918204, 87.50059374786743, 86.84583596975001, 87.03982316141132, 85.37682496239346, 85.25110168263657, 83.97596438380928, 83.41208939448236, 82.55739863925555, 81.94925315891707, 80.96568602098652, 80.85911803728241, 80.39388198932151, 78.44711925516694, 77.76819158050323, 77.44689308921305]

## --- Test PerpleX configuration and queries
@static if Sys.isunix()

    scratchdir = "./"

    # Kelemen (2014) primitive continental basalt excluding Mn and Ti since most melt models can"t handle them..
    elements =       [ "SiO2", "Al2O3",  "FeO",  "MgO",  "CaO", "Na2O",  "K2O",  "H2O",  "CO2",]
    concentrations = [50.0956, 15.3224, 8.5103, 9.2520, 9.6912, 2.5472, 0.8588, 2.0000, 0.6000,]
    composition = NCKFMASHTOCO2trace{Float64}(concentrations, elements)

    # Emphasis on phases from Holland and Powell -- all phases can be used with hp02ver.dat.
    HP_solution_phases = "Omph(HP)\nOpx(HP)\nAnth\nO(HP)\nSp(HP)\nGt(HP)\nfeldspar_B\nMica(CF)\nBio(TCC)\nCtd(HP)\nSt(HP)\nDo(HP)\nT\nB\nF\n"
    HP_excludes = ""

    ## --- # # # # # # # # # # # # # Isobaric example # # # # # # # # # # # # # # # #

    # Input parameters
    P = 1000 # Pressure, bar
    T_range = (0+273.15, 1500+273.15) # Temperature range, Kelvin

    # Configure (run build and vertex)
    melt_model = "melt(HP)"
    @info "perplex_configure_isobar:"
    @time perplex_configure_isobar(scratchdir, composition, P, T_range,
        dataset="hp02ver.dat",
        npoints=100,
        excludes=HP_excludes,
        solution_phases=melt_model*"\n"*HP_solution_phases
    )

    ## --- Query all properties at a single temperature -- results returned as text

    T = 850+273.15
    data_isobaric = perplex_query_point(scratchdir, T)
    @test isfile("./out1/1_1.txt")
    @test isa(data_isobaric, String)

    ## --- Query the full isobar -- results returned as dict

    bulk = perplex_query_system(scratchdir, importas=:Tuple, npoints=100)
    @test isa(bulk, NamedTuple)
    @test haskey(bulk, :SIO2)
    if haskey(bulk, :SIO2)
        @test haskey(bulk, :SIO2) && !isempty(bulk.SIO2)
        @test length(bulk.SIO2) == 100
        @test all(isapprox.(bulk.SIO2, 50.66433039859823, atol=0.1))
    end

    melt = perplex_query_phase(scratchdir, melt_model, importas=:Tuple, npoints=100)
    @test isa(melt, NamedTuple)
    @test haskey(melt, :SIO2)

    if haskey(melt, :SIO2)
        @test !isempty(melt.SIO2) && !any(x->x<45, melt.SIO2) && !any(x->x>75, melt.SIO2)
        @test length(melt.SIO2) == 100
        @test isapprox(melt.SIO2,  [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 66.23928873932091, 66.20069536595133, 66.1129689269046, 65.96817295304906, 65.77167961077932, 65.5254393152636, 65.23386085968349, 64.87278962035367, 64.45898710820259, 64.04463202231602, 63.2097683951158, 62.229362662382414, 61.2299, 60.24657590136964, 59.299682210095334, 58.39293503576102, 57.528805752880565, 56.697199999999995, 55.900244720195786, 55.151072424463784, 54.444161889086686, 53.77171075434216, 53.13486811907912, 52.53058424082473, 51.97033118219873, 51.615110323022066, 51.531989693602064, 51.49388455183463, 51.45425369117167, 51.4165640084052, 51.38137430931284, 51.34737946104821, 51.31412565706284, 51.282015384604605, 51.252599999999994, 51.2249358574551, 51.196284641114616, 51.169935818955075, 51.1451744274128, 51.11510000000001, 50.45745550320106, 50.40943024565815], nans=true, atol = 0.1)
    end

    modes = perplex_query_modes(scratchdir; importas=:Dict, npoints=100)
    @test isa(modes, Dict)
    @test haskey(modes, "Do(HP)")
    if haskey(modes, "Do(HP)")
        @test length(modes["Do(HP)"]) == 100
        @test isapprox(modes["Do(HP)"],  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.381821359304602, 1.375915226299608, 1.3738211840050927, 1.374457738329655, 1.3705253254297285, 1.366661347624855, 1.3645275034904318, 1.3701797192769967, 1.375450810802064, 1.3797663596440084, 1.38170983102423, 1.3835908068064018, 1.3914280845348614, 1.4096547846120548, 1.4188273299579084, 1.417632212772262, 1.416519868920687, 1.415345984868765, 1.415345984868765, 1.4144863360848499, 1.4126771598516183, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], nans=true, atol = 0.1)
    end
    if haskey(modes, "Omph(HP)")
        @test length(modes["Omph(HP)"]) == 100
        @test isapprox(modes["Omph(HP)"],[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.0339723566900236, 14.960931973118665, 15.062263362661524, 15.164506420058737, 15.268082701516247, 15.372961492756188, 15.47935889951888, 16.023147006631838, 17.195113428726106, 18.546171502024475, 18.513626566383596, 18.921480372141023, 18.938381437801173, 18.95517180349422, 18.971868712229128, 18.987725829804052, 19.003917068704503, 19.019482276868484, 19.034156503334277, 19.04772018291329, 18.955385576325604, 18.66836547025949, 18.700498131123354, 18.672603711178727, 18.689706911851058, 18.70741316163515, 18.726321687261198, 18.74703357720072, 18.769573446275686, 18.793658820257388, 18.821264934638325, 18.852397423440955, 18.8867110753726, 18.978007255636545, 19.10394367818196, 19.245715839150208, 19.40418088373046, 19.579886180363193, 19.774964084364957, 19.991810067185163, 20.241688665240932, 20.52557287224623, 20.84732371711889, 21.210565263460555, 21.618170448738216, 22.09663695953447, 22.646817318444732, 23.25441852307975, 23.214082721363855, 22.81470048851166, 22.43291893689257, 22.066189222773463, 21.721311293034898, 21.399604352976905, 21.097623567233256, 20.8182863046844, 20.557653077344202, 20.318180516294838, 20.09688085563381, 19.885716974177978, 19.695776424220245, 19.521123834193872, 18.711834731308517, 0.0, 0.0], nans=true, atol = 0.1)
    end

    # --- # # # # # # # # # # # Geothermal gradient example # # # # # # # # # # # #

    # Input parameters
    P_range = (280, 28000) # Pressure range to explore, bar (roughly 1-100 km depth)
    T_surf = 273.15 # Temperature of surface (K)
    geotherm = 0.01 # For reference, a geothermal gradient of 0.1 K/bar ≈ 28.4 K/km
    melt_model = ""

    # Configure (run build and vertex)
    @info "perplex_configure_geotherm:"
    @time perplex_configure_geotherm(scratchdir, composition, P_range, T_surf, geotherm;
        dataset="hp02ver.dat",
        excludes=HP_excludes,
        solution_phases=HP_solution_phases,
        npoints=100,
        index=2
    )

    seismic = perplex_query_seismic(scratchdir, index=2)
    @test isa(seismic, Dict)
    @test haskey(seismic, "T(K)")
    @test isa(seismic["T(K)"], Vector{Float64})
    @test nanminimum(seismic["T(K)"]) ≈ T_surf atol = 10
    @test nanmaximum(seismic["T(K)"]) ≈ T_surf + last(P_range)*geotherm atol = 10

    seismic = perplex_query_seismic(scratchdir, index=2, npoints=100)
    @test isa(seismic, Dict)
    @test haskey(seismic, "T(K)")
    @test isa(seismic["T(K)"], Vector{Float64})
    @test length(seismic["T(K)"]) == 100
    @test isapprox(seismic["T(K)"], [275.95, 278.75, 281.55, 284.35, 287.15, 289.95, 292.75, 295.55, 298.35, 301.15, 303.95, 306.75, 309.55, 312.35, 315.15, 317.95, 320.75, 323.55, 326.35, 329.15, 331.95, 334.75, 337.55, 340.35, 343.15, 345.95, 348.75, 351.55, 354.35, 357.15, 359.95, 362.75, 365.55, 368.35, 371.15, 373.95, 376.75, 379.55, 382.35, 385.15, 387.95, 390.75, 393.55, 396.35, 399.15, 401.95, 404.75, 407.55, 410.35, 413.15, 415.95, 418.75, 421.55, 424.35, 427.15, 429.95, 432.75, 435.55, 438.35, 441.15, 443.95, 446.75, 449.55, 452.35, 455.15, 457.95, 460.75, 463.55, 466.35, 469.15, 471.95, 474.75, 477.55, 480.35, 483.15, 485.95, 488.75, 491.55, 494.35, 497.15, 499.95, 502.75, 505.55, 508.35, 511.15, 513.95, 516.75, 519.55, 522.35, 525.15, 527.95, 530.75, 533.55, 536.35, 539.15, 541.95, 544.75, 547.55, 550.35, 553.15], nans=true, atol = 0.1)

    ## --- # # # # # # # # # # # P–T path example # # # # # # # # # # # #

    # Input parameters
    T_range = (550+273.15, 1050+273.15) #K
    PTdir = ""
    PTfilename = ""

    @info "perplex_configure_path:"
    @time perplex_configure_path(scratchdir, concentrations, PTdir, PTfilename, uppercase.(elements), T_range, 
        dataset = "hp02ver.dat", 
        solution_phases=HP_solution_phases, 
        excludes=HP_excludes,
        index=1, 
    )
    
    modes = perplex_query_modes(scratchdir, index=1, npoints=100)
    @test isa(modes, Dict)
    @test haskey(modes,"node")
    @test haskey(modes, "O(HP)")
    if haskey(modes, "O(HP)")
        @test isapprox(modes["O(HP)"], [0.13263234069934907])
    end

    # --- # # # # # # # # # # # Pseudosection example # # # # # # # # # # # # #

    P_range = (1000, 5000) # Pressure range to explore, bar
    T_range = (400+273.15, 600+273.15) # Temperature range to explore, K
    melt_model = ""

    solution_phases = "Opx(HP)\nO(HP)\nF\n"
    excludes = ""

    # Configure (run build and vertex)
    @info "perplex_configure_pseudosection:"
    @time perplex_configure_pseudosection(scratchdir, composition, P_range, T_range, 
        dataset="hp02ver.dat", 
        excludes=excludes,
        solution_phases=melt_model*solution_phases, 
        index=1, xnodes=50, ynodes=50
    )

    # Query modes on diagonal line across P-T space
    modes = perplex_query_modes(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(modes, Dict) && !isempty(modes)
    @test haskey(modes,"T(K)") && all(extrema(modes["T(K)"]) .≈ T_range)
    @test length(modes["T(K)"]) == 200

    phase = perplex_query_phase(scratchdir, "Opx(HP)", P_range, T_range, index=1, npoints=200)
    @test isa(phase, Dict) && !isempty(phase)
    @test haskey(phase,"T(K)") && all(extrema(phase["T(K)"]) .≈ T_range)
    @test length(phase["T(K)"]) == 200

    sys = perplex_query_system(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(sys, Dict) && !isempty(sys)
    @test haskey(sys,"T(K)") && all(extrema(sys["T(K)"]) .≈ T_range)
    @test length(sys["T(K)"]) == 200

    # Query seismic properties on diagonal line across P-T space
    seismic = perplex_query_seismic(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(seismic, Dict) && !isempty(seismic)
    @test haskey(seismic,"T(K)") && !isempty(seismic["T(K)"]) && all(extrema(seismic["T(K)"]) .≈ T_range)
    @test length(seismic["T(K)"]) == 200
    @test haskey(seismic, "rho,kg/m3") && !isempty(seismic["rho,kg/m3"]) && !any(x->x<2700, seismic["rho,kg/m3"]) && !any(x->x>3200, seismic["rho,kg/m3"])


    # Query properties on a manually-specified diagonal P-T line
    P = range(first(P_range), last(P_range), length=16)
    T = range(first(T_range), last(T_range), length=16)

    modes = perplex_query_modes(scratchdir, P, T, index=1)
    @test isa(modes, Dict) && !isempty(modes)
    @test haskey(modes,"T(K)") && all(isapprox.(modes["T(K)"], T, atol=0.1))

    phase = perplex_query_phase(scratchdir, "Opx(HP)", P, T, index=1)
    @test isa(phase, Dict) && !isempty(phase)
    @test haskey(phase,"T(K)") && all(isapprox.(phase["T(K)"], T, atol=0.1))

    sys = perplex_query_system(scratchdir, P, T, index=1)
    @test isa(sys, Dict) && !isempty(sys)
    @test haskey(sys,"T(K)") && all(isapprox.(sys["T(K)"], T, atol=0.1))
    @test haskey(sys, "rho,kg/m3") && !any(x->x<2700, sys["rho,kg/m3"]) && !any(x->x>3200, sys["rho,kg/m3"])

    seismic = perplex_query_seismic(scratchdir, P, T, index=1)
    @test isa(seismic, Dict) && !isempty(seismic)
    @test haskey(seismic,"T(K)")
    if haskey(seismic,"T(K)")
        @test isapprox(seismic["T(K)"], T, atol=0.01)
        @test isapprox(seismic["T(K)"], [673.15, 686.483, 699.817, 713.15, 726.483, 739.817, 753.15, 766.483, 779.817, 793.15, 806.483, 819.817, 833.15, 846.483, 859.817, 873.15], atol=0.1)
    end
    @test haskey(seismic, "rho,kg/m3")
    if haskey(seismic, "rho,kg/m3")
        @test !any(x->x<2700, seismic["rho,kg/m3"]) && !any(x->x>3200, seismic["rho,kg/m3"])
        @test isapprox(seismic["rho,kg/m3"], [2875.21, 2875.21, 2875.21, 2875.21, 2875.2, 2875.34, 2875.32, 2905.4, 2927.22, 2933.56, 2933.46, 2933.36, 2933.26, 2933.15, 2956.4, 2962.18], atol=0.1)
    end

    ## --- # # # # # # # # Isobaric example with more advanced models # # # # # # # # #

    # Kelemen (2014) primitive continental basalt
    elements =       [ "SiO2", "TiO2", "Al2O3",  "FeO",  "MgO",  "CaO", "Na2O",  "K2O",  "H2O",  "CO2",  "Mn",  "P",  "La",  "Ce", "Pr",  "Nd", "Sm", "Eu", "Gd", "Tb", "Dy", "Ho", "Er", "Tm", "Yb", "Lu",  "Sc",    "V",   "Cr", "Co",   "Ni",  "Cu", "Zn",  "Rb",  "Sr",   "Y", "Zr", "Nb", "Cs",   "Ba", "Hf", "Ta", "Pb", "Th",  "U",]
    concentrations = [50.0956, 0.9564, 15.3224, 8.5103, 9.2520, 9.6912, 2.5472, 0.8588, 2.0000, 0.6000, 1316., 960., 11.85, 25.87, 2.85, 14.88, 3.43, 1.07, 3.55, 0.51, 3.32, 0.68, 1.95, 0.29, 1.82, 0.28, 32.51, 246.59, 397.96, 41.2, 158.74, 91.91, 81.3, 18.63, 425.7, 18.69, 92.7, 6.23, 0.71, 295.04, 2.14, 0.45, 3.36, 2.03, 0.53,]
    composition = NCKFMASHTOCO2trace{Float64}(concentrations, elements)

    P = 5000 # Pressure, bar
    T_range = (750+273.15, 1250+273.15) # Temperature range, Kelvin
    solution_phases = "melt(HGPH)\nFsp(HGP)\nlAb(HGP)\nGt(HGP)\nO(HGP)\nOpx(HGP)\nCpx(HGP)\nIlm(WPH)\n"

    # Configure (run build and vertex)
    @info "perplex_configure_isobar:"
    @time perplex_configure_isobar(scratchdir, composition, P, T_range; solution_phases, index=3, npoints=32)

    results = perplextrace_query(scratchdir, composition, index=3, npoints=8)
    @test results isa Dict{String, Union{Vector{Float64}, Vector{String}}}
    expected = Dict{String, Union{Vector{Float64}, Vector{String}}}("Melt_Cs" => [5.6169508259412755, 4.689437851686781, 3.6375713627644046, 2.5520570096722373, 1.5416325613857829, 0.8624565391846193, 0.7154946383251302, 0.71], "phl" => [6.398824153307638, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_CaO" => [2.6609300798279025, 3.069411227764491, 3.7405411969731834, 5.132378870876649, 7.266098982746142, 9.67852203248963, 9.798792743661966, 9.714250971425097], "Melt_La" => [174.64791896120843, 64.60729666295458, 54.1545101412142, 40.557826037320815, 25.063066115390615, 14.336926928780775, 11.942307596761301, 11.85], "Melt_Co" => [40.169343670815266, 36.11489928435591, 31.931393796879863, 32.20075392802043, 34.68905472400545, 35.47355101974921, 40.0155556852075, 41.2], "Melt_v0_{T}" => [0.000114817, 3.65941e-5, -3.98635e-5, -0.000116592, -0.000181218, -0.000221995, -0.000231962, -0.000233658], "Fsp(HGP)" => [44.45050245829608, 34.231557933095715, 31.257652406334994, 26.780559478011824, 18.664716278923667, 3.8237420385117957, 0.0, 0.0], "Melt_Sm" => [20.596057905113323, 12.580189633935548, 11.266973044105775, 9.332966520250402, 6.399794557842739, 4.059205419402056, 3.4566004111311837, 3.43], "Melt_Nd" => [110.66640334541711, 61.73698690886034, 54.74599570337854, 44.21975239885048, 29.200350349461537, 17.772263966228667, 14.995700447892558, 14.88], "Melt_Th" => [65.66436742868282, 13.199859259905134, 10.362035301988717, 7.303830363825854, 4.405624376360775, 2.4663772863945965, 2.045813735913323, 2.03], "Melt_Gruneisen_T" => [0.795603, 0.731129, 0.660655, 0.576404, 0.490805, 0.421119, 0.396404, 0.381416], "CO2" => [0.5945261089399303, 0.5488135683607758, 0.524324463961817, 0.4854929863263197, 0.4159121461680162, 0.28980041935463613, 0.1737955962773984, 0.07132446565798997], "Melt_Rb" => [227.51492448648438, 122.47560101394814, 95.61343538999648, 67.00503249251517, 40.42270750132915, 22.631858685934226, 18.77489969840294, 18.63], "Melt_Tb" => [2.5929116448946106, 1.6771119159613124, 1.4833904233605493, 1.2471609974418612, 0.9005256147248529, 0.5971104306337491, 0.513920033767597, 0.51], "Melt_Ta" => [6.702579883412981, 2.4354665837329708, 1.9740322876713448, 1.4755482269173843, 0.9531449605389208, 0.5454818296050404, 0.4534674087559048, 0.45], "Ilm(WPH)" => [1.5576962883206913, 1.3640757024602723, 1.2018675880620904, 0.902487255191834, 0.27562101597951416, 0.0, 0.0, 0.0], "Melt_vp_{T}" => [0.000114817, 3.65941e-5, -3.98635e-5, -0.000116592, -0.000181218, -0.000221995, -0.000231962, -0.000233658], "apatite" => [0.39746797980963067, 0.26377626658251907, 0.14009730132888493, NaN, NaN, NaN, NaN, NaN], "Melt_Hf" => [8.1547997256861, 10.306942399816428, 8.513580412945064, 6.458703768755077, 4.269818022918713, 2.563810537836114, 2.15656424921494, 2.14], "Melt_Gd" => [19.911951375382888, 12.47165773245808, 11.077444579203405, 9.223485781071371, 6.480199476176333, 4.183597259689661, 3.5774660115268717, 3.55], "all_melts" => [2.6263305728136292, 18.01792741708122, 22.863400572189015, 31.857087224785346, 50.4261962358569, 84.79075525052974, 99.05248159831808, 99.928675534342], "melt(HGPH)" => [2.615789112058797, 18.01792741708122, 22.863400572189015, 31.857087224785346, 50.4261962358569, 84.79075525052974, 99.05248159831808, 99.928675534342], "Melt_Sr" => [7229.791176336427, 2415.0921663359677, 1959.8210230973625, 1431.5219384933935, 892.490463277368, 514.2627388346124, 429.01625152357866, 425.7], "Melt_FeO" => [1.2893300386799014, 2.0608008243203293, 3.703161185011579, 6.111788655406496, 8.391188825233563, 8.486911782251475, 8.491422377598264, 8.530540853054086], "Melt_CO2" => [0.24641600739248024, 0.28962711585084633, 0.3353581073145943, 0.36257192023417756, 0.36704394861384715, 0.3670190770740062, 0.4312891207609537, 0.5300520530052053], "Melt_Al2O3" => [20.41090061232702, 20.21140808456323, 19.120406118529957, 17.72929609955486, 16.503197689552323, 16.24870341222772, 15.494704338517213, 15.358801535880154], "Cpx(HGP)" => [20.693057283105805, 20.50425716105938, 20.59022239092929, 19.79315941567233, 15.811875542301177, 4.269512556954739, 0.0, 0.0], "zircon" => [0.014263797264714191, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_vol_pct" => [3.53173, 23.4862, 28.4711, 37.1977, 54.567, 86.2054, 98.7985, 99.7573], "Melt_T(K)" => [1023.15, 1094.58, 1166.01, 1237.44, 1308.86, 1380.29, 1451.72, 1523.15], "Melt_wt_pct" => [2.62633, 18.0179, 22.8634, 31.8571, 50.4262, 84.7908, 99.0525, 99.9287], "Melt_MgO" => [0.7710590231317708, 1.3487405394962158, 2.181990698237023, 3.4848192333397687, 5.230319267755302, 7.209231513938619, 9.002832520793104, 9.274010927401093], "Melt_P(bar)" => [5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0], "Melt_v0_{P}" => [9.61573e-5, 0.000100458, 0.000107143, 0.000113736, 0.000121071, 0.000130132, 0.000142155, 0.000154029], "Melt_Sc" => [48.95211096303728, 40.45257971597872, 35.278154380422585, 33.7352378562921, 33.48157179813252, 33.10883556244345, 32.706567492819886, 32.51], "Melt_Eu" => [8.567848919770775, 4.468217404824265, 3.8070542091868753, 3.0160781865219604, 2.044390176700263, 1.2716863915299097, 1.0782786555551913, 1.07], "Melt_vp,km/s" => [2.46944, 2.45714, 2.43666, 2.42045, 2.43433, 2.48962, 2.4558, 2.38398], "Melt_Dy" => [16.46076406962522, 10.747531073940662, 9.534721190384358, 7.995106270212085, 5.790408960831876, 3.8776687910261094, 3.345552266706226, 3.32], "sphene" => [0.010541460754832496, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_M" => [2.035559267559843, 2.08816607810154, 2.1833364839321585, 2.409727584950793, 2.8041342853462816, 3.219638995782255, 3.398384934098518, 3.415409159061836], "Melt_alpha,1/K" => [0.000216935, 0.000194271, 0.00017398, 0.000150311, 0.000124586, 0.000102181, 9.95389e-5, 0.000101709], "parg_dqf" => [0.024659042122748626, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_ApSat_P" => [1549.6850659862916, 2262.822995261286, 3199.0512110529494, 4812.022719429285, 7557.273774130887, 11099.700621377684, 15317.391719793734, 20283.71903509682], "Melt_cp,J/K/mol" => [138.996, 152.929, 167.712, 188.261, 213.184, 234.428, 240.882, 239.587], "Melt_Nb" => [117.77722880795167, 36.254028475056295, 29.080635593953605, 21.250650115365072, 13.37336916332584, 7.566205118865929, 6.278457546671376, 6.23], "Melt_Ks,bar" => [126916.0, 130148.0, 133112.0, 138982.0, 149845.0, 163035.0, 159494.0, 149132.0], "all_fluids" => [1.357674185823274, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_ZrnSat_Zr" => [371.03100107208974, 751.4551994699366, 1477.5228085365966, 3168.895390233873, 7819.499901932037, 18882.931007944448, 33312.31869871125, 47096.71721855231], "Melt_Zr" => [371.03100107208974, 497.4032467632092, 404.2230241832926, 298.38041459274285, 190.8704093576414, 111.66004862669534, 93.41675702337794, 92.7], "Melt_Yb" => [9.934301567574924, 6.514335617150518, 5.599921633354715, 4.569317605928195, 3.2670476154227064, 2.1359783740861413, 1.8338578095603062, 1.82], "Melt_v0,km/s" => [2.46944, 2.45714, 2.43666, 2.42045, 2.43433, 2.48962, 2.4558, 2.38398], "Melt_rho,kg/m3" => [2081.24, 2155.66, 2241.97, 2372.28, 2528.63, 2630.35, 2644.59, 2624.01], "Melt_n,mol" => [0.0313656, 0.188698, 0.212798, 0.258096, 0.355221, 0.543061, 0.621699, 0.631058], "Melt_W" => [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_Ce" => [298.2859857886868, 131.11746093904713, 112.38166637266146, 86.88961446049503, 54.223070501205434, 31.251109062917834, 26.071373199624688, 25.87], "Melt_Na2O" => [7.154550214636507, 6.374772549909019, 6.106941954221425, 5.272948839951255, 4.034599435156079, 2.9081706107158287, 2.5758407212354015, 2.5532602553260255], "Melt_K2O" => [3.8781601163448034, 4.5700418280167305, 3.6345811630659726, 2.6353894202143278, 1.6842097642106328, 1.0124902126229447, 0.8684582431683079, 0.8608430860843087], "Melt_vp_P" => [9.61573e-5, 0.000100458, 0.000107143, 0.000113736, 0.000121071, 0.000130132, 0.000142155, 0.000154029], "Melt_Ba" => [2466.818067356424, 1933.8311819044611, 1510.0355408272496, 1060.8481869613856, 640.6546067838842, 358.4505834547237, 297.3387040067245, 295.04], "Melt_Mo" => [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_cp/cv" => [1.17659, 1.15547, 1.13402, 1.10721, 1.08003, 1.05939, 1.05728, 1.05909], "Melt_mol_pct" => [6.23248, 34.4653, 38.5725, 46.1126, 61.4115, 87.4384, 98.5611, 99.7443], "Melt_Lu" => [1.3958795669963633, 0.9566485297972884, 0.8337266774144341, 0.6843528094236061, 0.49370951075425634, 0.3273974736918346, 0.28211333808302586, 0.28], "Melt_Ks_{P}" => [11.0606, 11.7975, 12.8403, 14.1686, 15.9852, 18.1029, 19.522, 20.3299], "Melt_P" => [1549.6850659862916, 2262.822995261286, 3199.0512110529494, 3396.8631609109925, 2066.2573059737706, 1163.663607682565, 967.2223949607456, 960.0], "Melt_N,g" => [83.5936, 95.3269, 107.263, 123.226, 141.721, 155.875, 159.061, 158.088], "H2O" => [1.357674185823274, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_SiO2" => [49.159501474785046, 50.38012015204805, 51.64451652624529, 51.96988856662452, 51.222692828823, 50.63501063335224, 50.34701409716394, 50.2148050214805], "Melt_Cr" => [199.18337714717225, 197.21187536225338, 177.2200279414633, 181.80585442323283, 217.56540396942728, 316.5118147662222, 397.3668416694425, 397.96], "Opx(HGP)" => [20.30110651588041, 21.4798776471744, 19.63072764349442, 16.08410186086329, 10.4339387019774, 3.4466656354202168, 0.0, 0.0], "elements" => ["P(bar)", "T(C)", "all_fluids", "all_melts", "all_solids", "melt(HGPH)", "apatite", "CO2", "Cpx(HGP)", "Fsp(HGP)", "H2O", "Ilm(WPH)", "O(HGP)", "Opx(HGP)", "parg_dqf", "phl", "sphene", "zircon", "Melt_T(K)", "Melt_P(bar)", "Melt_V,J/bar/mol", "Melt_Gruneisen_T", "Melt_Ks,bar", "Melt_v0,km/s", "Melt_vp,km/s", "Melt_rho,kg/m3", "Melt_cp,J/K/mol", "Melt_alpha,1/K", "Melt_beta,1/bar", "Melt_S,J/K/mol", "Melt_n,mol", "Melt_N,g", "Melt_Ks_{P}", "Melt_v0_{T}", "Melt_vp_{T}", "Melt_v0_{P}", "Melt_vp_P", "Melt_cp/cv", "Melt_vol_pct", "Melt_wt_pct", "Melt_mol_pct", "Melt_SiO2", "Melt_TiO2", "Melt_Al2O3", "Melt_FeO", "Melt_MgO", "Melt_CaO", "Melt_Na2O", "Melt_K2O", "Melt_H2O", "Melt_CO2", "Melt_M", "Melt_ZrnSat_Zr", "Melt_ApSat_P", "Melt_P", "Melt_Rb", "Melt_Cs", "Melt_Sr", "Melt_Ba", "Melt_Sc", "Melt_V", "Melt_Cr", "Melt_Mn", "Melt_Co", "Melt_Ni", "Melt_La", "Melt_Ce", "Melt_Nd", "Melt_Sm", "Melt_Eu", "Melt_Gd", "Melt_Tb", "Melt_Dy", "Melt_Yb", "Melt_Lu", "Melt_Y", "Melt_Zr", "Melt_Hf", "Melt_Nb", "Melt_Ta", "Melt_Mo", "Melt_W", "Melt_Th", "Melt_U"], "all_solids" => [117.70254517445346, 104.5409886307752, 97.58496749673456, 84.64400890494343, 59.867451335932, 18.36610996553585, 0.7737228054045144, 0.0], "Melt_TiO2" => [0.22102542530807678, 0.5765732306292922, 0.7703502465120788, 1.012439777263249, 1.3278598140996258, 1.0912702291667482, 0.9671552708034756, 0.9586750958675097], "Melt_U" => [15.26696994528537, 3.505965632798189, 2.7399327222745433, 1.9195462012354896, 1.1538371292907141, 0.6442800201769788, 0.5341317151645298, 0.53], "Melt_Mn" => [2786.358023986152, 2079.318254211816, 1820.578400265119, 1734.9259214542396, 1649.1319518192702, 1386.2439416330506, 1315.1841996351006, 1316.0], "P(bar)" => [5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0], "Melt_beta,1/bar" => [9.27062e-6, 8.8781e-6, 8.5193e-6, 7.96658e-6, 7.20765e-6, 6.49797e-6, 6.62898e-6, 7.10169e-6], "O(HGP)" => [1.995623391389803, 3.8534905707682343, 3.9318049350283624, 4.097111779149035, 3.971740078793336, 3.3795240992288798, 0.7737228054045144, 0.0], "Melt_S,J/K/mol" => [266.024, 295.663, 326.782, 364.603, 405.521, 437.653, 455.528, 465.238], "Melt_H2O" => [14.044600421338014, 11.118504447401778, 8.762152803888897, 6.288478616534705, 3.9727894438094773, 2.3626704961608045, 2.0224905662973582, 2.0047602004760203], "Melt_V" => [373.33044416079713, 367.7190140418788, 348.78880084203973, 327.11910551511795, 302.1256229631576, 265.67848386680686, 248.29954458628796, 246.59], "Melt_Ni" => [26.97404971175123, 68.68993513949361, 65.30415035919751, 64.75262589266623, 70.50945709448841, 95.09818756063126, 144.38846897558585, 158.74], "Melt_V,J/bar/mol" => [4.01654, 4.42217, 4.78434, 5.19443, 5.60468, 5.92603, 6.01458, 6.02468], "T(C)" => [750.0, 821.43, 892.86, 964.2900000000001, 1035.71, 1107.1399999999999, 1178.5700000000002, 1250.0], "Melt_Y" => [86.70171643605742, 58.07715058175313, 51.899326513252724, 43.7306674774702, 32.109389220049394, 21.74978127581569, 18.83290022416441, 18.69])
    @test isequal(results, expected)
    # @info results

    results = perplextrace_query(scratchdir, composition; index=3, npoints=16, 
        export_bulk_kds=true, 
        export_mineral_kds=true, 
        export_mineral_compositions=true,
    )
    @test results isa Dict{String, Union{Vector{Float64}, Vector{String}}}
    @test results["Melt_TiO2"] ≈ [0.22102542530807678, 0.4901310686183496, 0.5649919209011312, 0.6494052013156122, 0.7419696067561085, 0.8450781267617189, 0.9593759328436849, 1.0877893146927318, 1.2335094942611076, 1.4051201264608117, 1.2409690320441547, 1.0339308581626123, 0.9871016742564476, 0.9638395180802412, 0.9591408369460578, 0.9586750958675097]  nans=true atol=0.1
    @test results["Zircon_Ti"] ≈ [10.46178465494583, 14.70993086274441, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]  nans=true atol=0.1
    @test results["Melt_Yb"] ≈ [9.934301567574924, 7.058059272898073, 6.560480386496718, 6.141442673726893, 5.7100536370144965, 5.309853064839537, 4.816689398022475, 4.2263255840998974, 3.6050998353028327, 3.004852240281504, 2.4793559375339167, 2.0043459098645013, 1.8699271867091483, 1.8278546707474832, 1.82, 1.82]  nans=true atol=0.1
    @test results["O(HGP)_Yb"] ≈ [0.2420250616303878, 0.1719524235190984, 0.16425539442962164, 0.15844312604874186, 0.15276300323869682, 0.14205630148251916, 0.12886252649889704, 0.11306832298500188, 0.09644845965127206, 0.07752220570282549, 0.06396492260864702, 0.05171013530754383, 0.04824226565090334, 0.04576417765406641, NaN, NaN]  nans=true atol=0.1
    @test results["Zircon_Yb"] ≈ [2030.628068826433, 1221.7239085816104, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]  nans=true atol=0.1
    @test results["D_Zircon_Yb"] ≈ [204.40572042369885, 173.0962947949238, 146.517275477939, 127.13397493623552, 110.75830818807661, 97.19355790478029, 85.90281398506957, 76.42272804273595, 68.39876667486593, 61.53349730851841, 55.67059237112709, 50.60736051666041, 46.211854431373546, 42.165972409851406, 38.813436366872956, 35.85810012188556]  nans=true atol=0.1

    ## --- End of PerpleX tests
end

