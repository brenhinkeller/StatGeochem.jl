## -- Perplex name abbreviations

    abbreviations = ("acm", "ak", "ab", "alm", "ames", "anl", "and", "andr", "any", "ank", "ann", "an", "anth", "fanth", "atg", "arag", "azr", "bdy", "mnbi", "bn", "apv", "cpv", "fpv", "mpv", "npv", "br", "cc", "fcar", "mcar", "cel", "fcel", "ccp", "afchl", "mnchl", "fctd", "mctd", "mnctd", "chr", "clin", "chum", "cz", "coe", "crd", "hcrd", "fcrd", "mncrd", "cor", "cv", "crst", "cumm", "daph", "deer", "diam", "dsp", "di", "dol", "east", "en", "ep", "fep", "esk", "fa", "ftr", "fper", "fs", "fo", "nagt", "ged", "geh", "geik", "gl", "fgl", "gth", "gph", "gr", "grun", "hlt", "hed", "hem", "herc", "heu", "abh", "ilm", "oilm", "iron", "jd", "kals", "kls", "kao", "ky", "larn", "lrn", "lmt", "law", "lc", "lime", "mft", "mag", "mt", "maj", "mal", "mang", "ma", "me", "merw", "mic", "mil", "mont", "mu", "cg", "cgh", "ne", "Ni", "bunsn", "osm1", "osm2", "fosm", "pa", "parg", "per", "phA", "phl", "naph", "ppv", "pre", "pswo", "pump", "pyr", "py", "pnt", "prl", "pxmn", "q", "rnk", "rhc", "rhod", "rieb", "frw", "mrw", "ru", "san", "spr4", "spr7", "fspr", "sid", "sill", "spss", "sph", "sp", "spu", "fst", "mst", "mnst", "stlb", "stv", "sud", "fsud", "syv", "ta", "fta", "teph", "ty", "tpz", "tr", "trd", "tro", "tats", "ts", "cats", "mgts", "usp", "vsv", "fwd", "mwd", "wrk", "wo", "wu", "Wu", "zrc", "zo", "CO2", "CO", "H2", "CH4", "O2", "H2O", "abL", "anL", "diL", "enL", "faL", "fliq", "foL", "h2oL", "hliq", "kspL", "mliq", "qL", "silL", "H+", "Cl-", "OH-", "Na+", "K+", "Ca++", "Mg++", "Fe++", "Al+++", "CO3", "AlOH3", "AlOH4-", "KOH", "HCL", "KCL", "NaCl", "CaCl2", "CaCl+", "MgCl2", "MgCl", "FeCl2", "aqSi", "Kf", "San", "San(TH)", "Bi(HGP)", "Bi(W)", "Bio(HP)", "Bio(TCC)", "Bio(WPH)", "Mpv(H)", "Pv", "Pv(fab)", "Pv(stx7)", "B", "C2/c(stx)", "Carb(M)", "Cc(AE)", "dis(EF)", "Do(AE)", "Do(HP)", "DoDo", "M(HP)", "oCcM(EF)", "oCcM(HP)", "Carp", "Carp(M)", "Carp(SGH)", "Chl(HP)", "Chl(LWV)", "Chl(W)", "Ctd(HP)", "Ctd(SGH)", "Ctd(W)", "Act(M)", "Amph(DHP)", "Amph(DPW)", "Ca-Amph(D)", "cAmph_I(DP)", "cAmph_I(G)", "cAmph(DP)", "cAmph(G)", "Cumm", "Gl", "GlTrTsMr", "GlTrTsPg", "Na-Amph(D)", "Tr", "Chum", "TiCh(PL)", "TiChdr(B)", "Augite(G)", "Cps(HGP)", "Cpx_I(HGP)", "Cpx(h)", "Cpx(HGP)", "Cpx(HP)", "Cpx(JH)", "Cpx(l)", "Cpx(m)", "Cpx(stx)", "Cpx(stx7)", "Cpx(stx8)", "Cpx(TH)", "Hpx(H)", "Omph(GHP)", "Omph(HP)", "Crd(HGP)", "Crd(W)", "hCrd", "Cor(H)", "Cpv(H)", "Ep(HP)", "Ep(HP11)", "CF(stx8)", "Cfer(H)", "Fper(H)", "Aq_solven0", "Aqfl(HGP)", "C-H-Fluid", "COH-Fluid", "COH-Fluid", "COH-Fluid+", "COHF", "F", "F(salt)", "GCOHF", "HO-Fluid", "HOS-Fluid", "Si-Fluid", "WADDAH", "CrGt", "Grt(JH)", "Gt(B)", "Gt(EWHP)", "Gt(GCT)", "Gt(HGP)", "Gt(HP)", "Gt(MPF)", "Gt(stx)", "Gt(stx8)", "Gt(TH)", "Gt(W)", "Gt(WPH)", "Gt(WPPH)", "Ygt(SP)", "ZrGt(KP)", "ZrGt(KP)", "CCO-vapor", "ideal_gas", "Si-vapor", "Aki", "Aki(fab)", "Aki(H)", "Aki(stx7)", "Aki(stx8)", "Eskol(C)", "IlGkPy", "IlHm(A)", "Ilm(DS6)", "Ilm(WPH)", "Ilm(WPH0)", "Gt(H)", "Maj", "casmelt", "FeCr(liq)", "FeS_liq", "FeSiC_liq", "LIQ(EF)", "LIQ(NK)", "Melt(A)", "Melt(B)", "melt(G)", "melt(HGP)", "melt(HGPH)", "melt(HP)", "Melt(JH)", "melt(SP)", "melt(TH)", "melt(W)", "MELTS(GS)", "mMELTS(G)", "pMELTS(G)", "Mnz(SP)", "Neph(FB)", "NAl(H)", "O(HGP)", "O(HKP)", "O(HP)", "O(HPK)", "O(JH)", "O(SG)", "O(stx)", "O(stx7)", "O(stx8)", "Ol(m)", "A", "Anth", "o-Amph", "oAmph(DP)", "CrOpx(HP)", "Opx(HGP)", "Opx(HP)", "Opx(JH)", "Opx(stx)", "Opx(stx8)", "Opx(TH)", "Opx(W)", "Osm(HP)", "Osm(HP11)", "Pl(h)", "Pl(JH)", "Pl(stx8)", "Ppv(og)", "Ppv(stx8)", "Pu", "Pu(M)", "Po(HP)", "Po(SE)", "hRg", "Ring", "Ring(H)", "Ring(stx)", "Ring(stx7)", "Ring(stx8)", "ZrRu", "Sa(WP)", "Sapp(HP)", "Sapp(KWP)", "Sapp(TP)", "Scap", "Atg(LE)", "Atg(PN)", "Liz(LE)", "CrSp", "GaHcSp", "MF", "Mt(W)", "MtUl(A)", "Sp_II(WPC)", "Sp(GS)", "Sp(HGP)", "Sp(HP)", "Sp(JH)", "Sp(JR)", "Sp(stx)", "Sp(stx7)", "Sp(stx8)", "Sp(TH)", "Sp(WPC)", "St(HP)", "St(W)", "Stlp", "Stlp(M)", "Sud", "Sud(Livi)", "Sud(M)", "T", "feldspar", "feldspar_B", "Fsp(C1)", "Fsp(HGP)", "lAb(HGP)", "Pl(I1,HP)", "Tour(V)", "hWd", "Wad", "Wad(H)", "Wad(stx)", "Wad(stx7)", "Wad(stx8)", "MaPa", "Mica(CF)", "Mica(CHA)", "Mica(CHA1)", "Mica(M)", "Mica(SGH)", "Mica(W)", "Mica+(CHA)", "Pheng(HP)", "Wus", "Wus(fab)", "Wus(stx7)",)
    common_names = ("acmite", "akermanite", "albite", "almandine", "amesite", "analcite", "andalusite", "andradite", "anhydrite", "ankerite", "annite", "anorthite", "anthophyllite", "anthophyllite-(Fe)", "antigorite", "aragonite", "azurite", "baddeleyite", "biotite-(Mn)", "bornite", "bridgmanite-(Al)", "bridgmanite-(Ca)", "bridgmanite-(Fe)", "bridgmanite", "bridgmanite-(Na)", "brucite", "calcite", "carpholite-(Fe)", "carpholite-(Mg)", "celadonite", "celadonite-(Fe)", "chalcopyrite", "chlorite-(Al-free)", "chlorite-(Mn)", "chloritoid-(Fe)", "chloritoid-(Mg)", "chloritoid-(Mn)", "chrysotile", "clinochlore", "clinohumite", "clinozoisite", "coesite", "cordierite", "cordierite", "cordierite-(Fe)", "cordierite-(Mn)", "corundum", "covellite", "cristobalite", "cummingtonite", "daphnite", "deerite", "diamond", "diaspore", "diopside", "dolomite", "eastonite", "enstatite", "epidote", "epidote-(Fe)", "eskolaite", "fayalite", "ferroactinolite", "ferropericlase", "ferrosilite", "forsterite", "garnet-(Na)", "gedrite", "gehlenite", "geikielite", "glaucophane", "glaucophane-(Fe)", "goethite", "graphite", "grossular", "grunerite", "halite", "hedenbergite", "hematite", "hercynite", "heulandite", "highalbite", "ilmenite", "ilmenite", "iron", "jadeite", "kalsilite", "kalsilite", "kaolinite", "kyanite", "larnite", "larnite", "laumontite", "lawsonite", "leucite", "lime", "magnesioferrite", "magnesite", "magnetite", "majorite", "malachite", "manganosite", "margarite", "meionite", "merwinite", "microcline", "millerite", "monticellite", "muscovite", "nepheline", "nepheline", "nepheline", "nickel", "nickel oxide", "osumilite", "osumilite", "osumilite-(Fe)", "paragonite", "pargasite", "periclase", "phase A", "phlogopite", "phlogopite-(Na)", "post-perovskite", "prehnite", "pseudowollastonite", "pumpellyite", "pyrite", "pyrope", "pyrophanite", "pyrophyllite", "pyroxmangite", "quartz", "rankinite", "rhodochrosite", "rhodonite", "riebeckite", "ringwoodite-(Fe)", "ringwoodite", "rutile", "sanidine", "sapphirine", "sapphirine", "sapphirine-(Fe)", "siderite", "sillimanite", "spessartine", "sphene", "spinel", "spurrite", "staurolite-(Fe)", "staurolite-(Mg)", "staurolite-(Mn)", "stilbite", "stishovite", "sudoite", "sudoite-(Fe)", "sylvite", "talc", "talc-(Fe)", "tephroite", "tilleyite", "topaz", "tremolite", "tridymite", "troilite", "tschermak-talc", "tschermakite", "tschermakite-(Ca)", "tschermakite-(Mg)", "ulvospinel", "vesuvianite", "wadsleyite-(Fe)", "wadsleyite-(Mg)", "wairakite", "wollastonite", "wustite", "wustite", "zircon", "zoisite", "carbon dioxide", "carbon monoxide", "hydrogen", "methane", "oxygen", "water", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "H+(aq)", "Cl(aq)", "OH(aq)", "Na+(aq)", "K+(aq)", "Ca2+(aq)", "Mg2+(aq)", "Fe2+(aq)", "Al3+(aq)", "CO3--(aq)", "Al(OH)3(aq)", "Al(OH)4----(aq)", "KOH(aq)", "HCl(aq)", "KCl(aq)", "NaCl(aq)", "CaCl(aq)", "CaCl+(aq)", "MgCl2(aq)", "MgCl+(aq)", "FeCl(aq)", "Si(aq)", "alkali feldspar", "alkali feldspar", "alkali feldspar", "biotite", "biotite", "biotite", "biotite", "biotite", "bridgmanite", "bridgmanite", "bridgmanite", "bridgmanite", "brucite", "C2/c-pyroxene", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carbonate", "carpholite", "carpholite", "carpholite", "chlorite", "chlorite", "chlorite", "chloritoid", "chloritoid", "chloritoid", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "amphibole", "clinohumite", "clinohumite", "clinohumite", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "clinopyroxene", "cordierite", "cordierite", "cordierite", "corundum", "davemaoite", "epidote", "epidote", "ferrite-(Ca)", "ferrite-(Ca)", "ferropericlase", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "fluid", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "garnet", "gas", "gas", "gas", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "ilmenite", "majorite", "majorite", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "melt", "monazite", "nepheline", "new aluminous phase", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "olivine", "orthoamphibole", "orthoamphibole", "orthoamphibole", "orthoamphibole", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "orthopyroxene", "osumilite", "osumilite", "plagioclase", "plagioclase", "plagioclase", "post-perovskite", "post-perovskite", "pumpellyite", "pumpellyite", "pyrrhotite", "pyrrhotite", "ringwoodite", "ringwoodite", "ringwoodite", "ringwoodite", "ringwoodite", "ringwoodite", "rutile", "sapphirine", "sapphirine", "sapphirine", "sapphirine", "scapolite", "serpentine", "serpentine", "serpentine", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "spinel", "staurolite", "staurolite", "stilpnomelane", "stilpnomelane", "sudoite", "sudoite", "sudoite", "talc", "ternary feldspar", "ternary feldspar", "ternary feldspar", "ternary feldspar", "ternary feldspar", "ternary feldspar", "tourmaline", "wadsleyite", "wadsleyite", "wadsleyite", "wadsleyite", "wadsleyite", "wadsleyite", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "white mica", "wustite", "wustite", "wustite",)

    @test perplex_common_name.(abbreviations) == common_names

    abbreviations = ("ak", "alm", "and", "andr", "chum", "cz", "crd", "ep", "fa", "fctd", "fcrd", "fep", "fosm", "fst", "fo", "geh", "gr", "hcrd", "tpz", "ky", "larn", "law", "merw", "mctd", "mst", "mnctd", "mncrd", "mnst", "mont", "osm1", "osm2", "phA", "pump", "py", "rnk", "sill", "spss", "sph", "spu", "teph", "ty", "vsv", "zrc", "zo", "acm", "cats", "di", "en", "fs", "hed", "jd", "mgts", "pswo", "pxmn", "rhod", "wo", "anth", "cumm", "fanth", "fgl", "ftr", "ged", "gl", "grun", "parg", "rieb", "tr", "ts", "deer", "fcar", "fspr", "mcar", "spr4", "spr7", "ann", "cel", "east", "fcel", "ma", "mnbi", "mu", "naph", "pa", "phl", "afchl", "ames", "clin", "daph", "fsud", "mnchl", "sud", "atg", "chr", "fta", "kao", "pre", "prl", "ta", "tats", "ab", "anl", "an", "coe", "crst", "heu", "abh", "kals", "lmt", "lc", "me", "mic", "ne", "q", "san", "stlb", "stv", "trd", "wrk", "bdy", "cor", "geik", "hem", "herc", "ilm","oilm","lime", "mft", "mt", "mang", "bunsn", "per", "pnt", "ru", "sp", "usp", "br", "dsp", "gth", "ank", "arag", "cc", "dol", "mag", "rhc", "sid", "diam", "gph", "iron", "Ni", "CO2", "CO", "H2", "CH4", "O2", "H2O", "abL", "anL", "diL", "enL", "faL", "fliq", "foL", "h2oL", "hliq", "kspL", "mliq", "qL", "silL", "H+", "Cl-", "OH-", "Na+", "K+", "Ca++", "Mg++", "Fe++", "Al+++", "CO3", "AlOH3", "AlOH4-", "KOH", "HCL", "KCL", "NaCl", "CaCl2", "CaCl+", "MgCl2", "MgCl", "FeCl2", "aqSi",)
    full_names = ("akermanite", "almandine", "andalusite", "andradite", "clinohumite", "clinozoisite", "cordierite", "epidote(ordered)", "fayalite", "Fe-chloritoid", "Fe-cordierite", "Fe-epidote", "Fe-osumilite", "Fe-staurolite", "forsterite", "gehlenite", "grossular", "hydrous cordierite", "hydroxy-topaz", "kyanite", "larnite-bredigite", "lawsonite", "merwinite", "Mg-chloritoid", "Mg-staurolite", "Mn-chloritoid", "Mn-cordierite", "Mn-staurolite", "monticellite", "osumilite(1)", "osumilite(2)", "phase A", "pumpellyite", "pyrope", "rankinite", "sillimanite", "spessartine", "sphene", "spurrite", "tephroite", "tilleyite", "vesuvianite", "zircon", "zoisite", "acmite", "Ca-tschermaks pyroxene", "Diopside", "enstatite", "ferrosilite", "hedenbergite", "jadeite", "mg-tschermak", "pseudowollastonite", "pyroxmangite", "rhodonite", "wollastonite", "anthophyllite", "cummingtonite", "Fe-anthophyllite", "Fe-glaucophane", "ferroactinolite", "gedrite(Na-free)", "glaucophane", "grunerite", "pargasite", "riebeckite", "tremolite", "tschermakite", "deerite", "fe-carpholite", "fe-sapphirine(793)", "mg-carpholite", "sapphirine(442)", "sapphirine(793)", "annite", "celadonite", "eastonite", "Fe-celadonite", "margarite", "Mn-biotite", "muscovite", "Na-phlogopite", "paragonite", "phlogopite", "Al-free chlorite", "amesite(14Ang)", "clinochlore(ordered)", "daphnite", "Fe-sudoite", "Mn-chlorite", "Sudoite", "antigorite", "chrysotile", "Fe-talc", "Kaolinite", "prehnite", "pyrophyllite", "talc", "tschermak-talc", "albite", "analcite", "anorthite", "coesite", "cristobalite", "heulandite", "highalbite", "kalsilite", "laumontite", "leucite", "meionite", "microcline", "nepheline", "quartz", "sanidine", "stilbite", "stishovite", "tridymite", "wairakite", "baddeleyite", "corundum", "geikielite", "hematite", "hercynite", "ilmenite", "ilmenite(ordered)","lime", "magnesioferrite", "magnetite", "manganosite", "nickel oxide", "periclase", "pyrophanite", "rutile", "spinel", "ulvospinel", "brucite", "diaspore", "goethite", "ankerite", "aragonite", "calcite", "dolomite", "magnesite", "rhodochrosite", "siderite", "diamond", "graphite", "iron", "nickel", "carbon dioxide", "carbon monoxide", "hydrogen", "methane", "oxygen", "water fluid", "albite liquid", "anorthite liquid", "diopside liquid", "enstatite liquid", "fayalite liquid", "Fe-liquid (in KFMASH)", "Forsterite liquid", "H2O liquid", "H2O liquid (in KFMASH)", "K-feldspar liquid", "Mg liquid (in KFMASH)", "Silica liquid", "Sillimanite liquid", "H+(aq)", "Cl(aq)", "OH(aq)", "Na+(aq)", "K+(aq)", "Ca2+(aq)", "Mg2+(aq)", "Fe2+(aq)", "Al3+(aq)", "CO3--(aq)", "Al(OH)3(aq)", "Al(OH)4----(aq)", "KOH(aq)", "HCl(aq)", "KCl(aq)", "NaCl(aq)", "CaCl(aq)", "CaCl+(aq)", "MgCl2(aq)", "MgCl+(aq)", "FeCl(aq)", "Aqueous silica",)

    @test perplex_expand_name.(abbreviations) == full_names
    @test perplex_abbreviate_name.(full_names) == abbreviations
    @test perplex_phase_is_solid.(("melt(HGP)", "q", "diL", "andr", "T(K)")) == (false, true, false, true, false)

    @test findall(germ_perplex_name_matches.(germ_kd["minerals"], germ_kd["minerals"])) == eachindex(germ_kd["minerals"])
    @test exp10.(germ_kd["Zircon"]["U"]) ≈ [97.01413147861255, 93.62762348710048, 95.70331912979036, 98.07492845798349, 97.81827502661368, 99.28851151199457, 97.21829495225793, 95.85968554222141, 93.98466548532939, 93.52699913659006, 90.30192324705912, 92.07442173740212, 93.3112484342126, 91.6254245554073, 92.51858884477585, 93.73979512420127, 91.41679685200128, 89.45446032995206, 89.60556859348364, 87.87897848691193, 86.28752257126347, 85.4411332509216, 85.30372575939623, 84.72196109236751, 85.00138458858598, 84.63655933302013, 84.56954616606329, 83.91353174074307, 82.5750794077659, 81.40592210050958, 80.89040316794367, 80.38351628740011, 79.46117816149064, 79.27787488908423, 78.20454615057248, 77.20474626671138, 76.0289512794068, 75.1292407643232, 74.16243829469089, 73.51331377941429, 72.82843876279755]

## --- Test PerpleX configuration and queries
@static if Sys.isunix()

    scratchdir = "./"

    # Kelemen (2014) primitive continental basalt excluding Mn and Ti since most melt models can"t handle them..
    elements =       [ "SiO2", "Al2O3",  "FeO",  "MgO",  "CaO", "Na2O",  "K2O",  "H2O",  "CO2",]
    concentrations = [50.0956, 15.3224, 8.5103, 9.2520, 9.6912, 2.5472, 0.8588, 2.0000, 0.6000,]
    composition = NCKFMASHTOCO2trace{Float64}(concentrations, elements)

    # Emphasis on phases from Holland and Powell -- all phases can be used with hp02ver.dat.
    HP_solution_phases = "Omph(HP)\nOpx(HP)\nAnth\nO(HP)\nSp(HP)\nGt(HP)\nfeldspar_B\nMica(CF)\nBio(TCC)\nCtd(HP)\nSt(HP)\nDo(HP)\nT\nB\nF\n"
    HP_excludes = ""

    ## --- # # # # # # # # # # # # # Isobaric example # # # # # # # # # # # # # # # #

    # Input parameters
    P = 1000 # Pressure, bar
    T_range = (0+273.15, 1500+273.15) # Temperature range, Kelvin

    # Configure (run build and vertex)
    melt_model = "melt(HP)"
    @info "perplex_configure_isobar:"
    @time perplex_configure_isobar(scratchdir, composition, P, T_range,
        dataset="hp02ver.dat",
        npoints=100,
        excludes=HP_excludes,
        solution_phases=melt_model*"\n"*HP_solution_phases
    )

    ## --- Query all properties at a single temperature -- results returned as text

    T = 850+273.15
    data_isobaric = perplex_query_point(scratchdir, T)
    @test isfile("./out1/1_1.txt")
    @test isa(data_isobaric, String)

    ## --- Query the full isobar -- results returned as dict

    bulk = perplex_query_system(scratchdir, importas=:Tuple, npoints=100)
    @test isa(bulk, NamedTuple)
    @test haskey(bulk, :SIO2)
    if haskey(bulk, :SIO2)
        @test haskey(bulk, :SIO2) && !isempty(bulk.SIO2)
        @test length(bulk.SIO2) == 100
        @test all(isapprox.(bulk.SIO2, 50.66433039859823, atol=0.1))
    end

    melt = perplex_query_phase(scratchdir, melt_model, importas=:Tuple, npoints=100)
    @test isa(melt, NamedTuple)
    @test haskey(melt, :SIO2)

    if haskey(melt, :SIO2)
        @test !isempty(melt.SIO2) && !any(x->x<45, melt.SIO2) && !any(x->x>75, melt.SIO2)
        @test length(melt.SIO2) == 100
        @test isapprox(melt.SIO2,  [NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, 66.23928873932091, 66.20069536595133, 66.1129689269046, 65.96817295304906, 65.77167961077932, 65.5254393152636, 65.23386085968349, 64.87278962035367, 64.45898710820259, 64.04463202231602, 63.2097683951158, 62.229362662382414, 61.2299, 60.24657590136964, 59.299682210095334, 58.39293503576102, 57.528805752880565, 56.697199999999995, 55.900244720195786, 55.151072424463784, 54.444161889086686, 53.77171075434216, 53.13486811907912, 52.53058424082473, 51.97033118219873, 51.615110323022066, 51.531989693602064, 51.49388455183463, 51.45425369117167, 51.4165640084052, 51.38137430931284, 51.34737946104821, 51.31412565706284, 51.282015384604605, 51.252599999999994, 51.2249358574551, 51.196284641114616, 51.169935818955075, 51.1451744274128, 51.11510000000001, 50.45745550320106, 50.40943024565815], nans=true, atol = 0.1)
    end

    modes = perplex_query_modes(scratchdir; importas=:Dict, npoints=100)
    @test isa(modes, Dict)
    @test haskey(modes, "Do(HP)")
    if haskey(modes, "Do(HP)")
        @test length(modes["Do(HP)"]) == 100
        @test isapprox(modes["Do(HP)"],  [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.381821359304602, 1.375915226299608, 1.3738211840050927, 1.374457738329655, 1.3705253254297285, 1.366661347624855, 1.3645275034904318, 1.3701797192769967, 1.375450810802064, 1.3797663596440084, 1.38170983102423, 1.3835908068064018, 1.3914280845348614, 1.4096547846120548, 1.4188273299579084, 1.417632212772262, 1.416519868920687, 1.415345984868765, 1.415345984868765, 1.4144863360848499, 1.4126771598516183, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], nans=true, atol = 0.1)
    end
    if haskey(modes, "Omph(HP)")
        @test length(modes["Omph(HP)"]) == 100
        @test isapprox(modes["Omph(HP)"],[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.0339723566900236, 14.960931973118665, 15.062263362661524, 15.164506420058737, 15.268082701516247, 15.372961492756188, 15.47935889951888, 16.023147006631838, 17.195113428726106, 18.546171502024475, 18.513626566383596, 18.921480372141023, 18.938381437801173, 18.95517180349422, 18.971868712229128, 18.987725829804052, 19.003917068704503, 19.019482276868484, 19.034156503334277, 19.04772018291329, 18.955385576325604, 18.66836547025949, 18.700498131123354, 18.672603711178727, 18.689706911851058, 18.70741316163515, 18.726321687261198, 18.74703357720072, 18.769573446275686, 18.793658820257388, 18.821264934638325, 18.852397423440955, 18.8867110753726, 18.978007255636545, 19.10394367818196, 19.245715839150208, 19.40418088373046, 19.579886180363193, 19.774964084364957, 19.991810067185163, 20.241688665240932, 20.52557287224623, 20.84732371711889, 21.210565263460555, 21.618170448738216, 22.09663695953447, 22.646817318444732, 23.25441852307975, 23.214082721363855, 22.81470048851166, 22.43291893689257, 22.066189222773463, 21.721311293034898, 21.399604352976905, 21.097623567233256, 20.8182863046844, 20.557653077344202, 20.318180516294838, 20.09688085563381, 19.885716974177978, 19.695776424220245, 19.521123834193872, 18.711834731308517, 0.0, 0.0], nans=true, atol = 0.1)
    end

    # --- # # # # # # # # # # # Geothermal gradient example # # # # # # # # # # # #

    # Input parameters
    P_range = (280, 28000) # Pressure range to explore, bar (roughly 1-100 km depth)
    T_surf = 273.15 # Temperature of surface (K)
    geotherm = 0.01 # For reference, a geothermal gradient of 0.1 K/bar ≈ 28.4 K/km
    melt_model = ""

    # Configure (run build and vertex)
    @info "perplex_configure_geotherm:"
    @time perplex_configure_geotherm(scratchdir, composition, P_range, T_surf, geotherm;
        dataset="hp02ver.dat",
        excludes=HP_excludes,
        solution_phases=HP_solution_phases,
        npoints=100,
        index=2
    )

    seismic = perplex_query_seismic(scratchdir, index=2)
    @test isa(seismic, Dict)
    @test haskey(seismic, "T(K)")
    @test isa(seismic["T(K)"], Vector{Float64})
    @test nanminimum(seismic["T(K)"]) ≈ T_surf atol = 10
    @test nanmaximum(seismic["T(K)"]) ≈ T_surf + last(P_range)*geotherm atol = 10

    seismic = perplex_query_seismic(scratchdir, index=2, npoints=100)
    @test isa(seismic, Dict)
    @test haskey(seismic, "T(K)")
    @test isa(seismic["T(K)"], Vector{Float64})
    @test length(seismic["T(K)"]) == 100
    @test isapprox(seismic["T(K)"], [275.95, 278.75, 281.55, 284.35, 287.15, 289.95, 292.75, 295.55, 298.35, 301.15, 303.95, 306.75, 309.55, 312.35, 315.15, 317.95, 320.75, 323.55, 326.35, 329.15, 331.95, 334.75, 337.55, 340.35, 343.15, 345.95, 348.75, 351.55, 354.35, 357.15, 359.95, 362.75, 365.55, 368.35, 371.15, 373.95, 376.75, 379.55, 382.35, 385.15, 387.95, 390.75, 393.55, 396.35, 399.15, 401.95, 404.75, 407.55, 410.35, 413.15, 415.95, 418.75, 421.55, 424.35, 427.15, 429.95, 432.75, 435.55, 438.35, 441.15, 443.95, 446.75, 449.55, 452.35, 455.15, 457.95, 460.75, 463.55, 466.35, 469.15, 471.95, 474.75, 477.55, 480.35, 483.15, 485.95, 488.75, 491.55, 494.35, 497.15, 499.95, 502.75, 505.55, 508.35, 511.15, 513.95, 516.75, 519.55, 522.35, 525.15, 527.95, 530.75, 533.55, 536.35, 539.15, 541.95, 544.75, 547.55, 550.35, 553.15], nans=true, atol = 0.1)

    ## --- # # # # # # # # # # # P–T path example # # # # # # # # # # # #

    # Input parameters
    T_range = (550+273.15, 1050+273.15) #K
    PTdir = ""
    PTfilename = ""

    @info "perplex_configure_path:"
    @time perplex_configure_path(scratchdir, concentrations, PTdir, PTfilename, uppercase.(elements), T_range, 
        dataset = "hp02ver.dat", 
        solution_phases=HP_solution_phases, 
        excludes=HP_excludes,
        index=1, 
    )
    
    modes = perplex_query_modes(scratchdir, index=1, npoints=100)
    @test isa(modes, Dict)
    @test haskey(modes,"node")
    @test haskey(modes, "O(HP)")
    if haskey(modes, "O(HP)")
        @test isapprox(modes["O(HP)"], [6.7642493756668])
    end

    # --- # # # # # # # # # # # Pseudosection example # # # # # # # # # # # # #

    P_range = (1000, 5000) # Pressure range to explore, bar
    T_range = (400+273.15, 600+273.15) # Temperature range to explore, K
    melt_model = ""

    solution_phases = "Opx(HP)\nO(HP)\nF\n"
    excludes = ""

    # Configure (run build and vertex)
    @info "perplex_configure_pseudosection:"
    @time perplex_configure_pseudosection(scratchdir, composition, P_range, T_range, 
        dataset="hp02ver.dat", 
        excludes=excludes,
        solution_phases=melt_model*solution_phases, 
        index=1, xnodes=50, ynodes=50
    )

    # Query modes on diagonal line across P-T space
    modes = perplex_query_modes(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(modes, Dict) && !isempty(modes)
    @test haskey(modes,"T(K)") && all(extrema(modes["T(K)"]) .≈ T_range)
    @test length(modes["T(K)"]) == length(modes["Opx(HP)"]) == 200
    @test nanmean(modes["Opx(HP)"]) ≈ 10.047218620689655 rtol=0.01

    phase = perplex_query_phase(scratchdir, "Opx(HP)", P_range, T_range, index=1, npoints=200)
    @test isa(phase, Dict) && !isempty(phase)
    @test haskey(phase,"T(K)") && all(extrema(phase["T(K)"]) .≈ T_range)
    @test length(phase["T(K)"]) == length(phase["SIO2"]) == 200
    @test nanmean(phase["SIO2"]) ≈ 49.11688856598355 rtol=0.01

    sys = perplex_query_system(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(sys, Dict) && !isempty(sys)
    @test haskey(sys,"T(K)") && all(extrema(sys["T(K)"]) .≈ T_range)
    @test length(sys["T(K)"]) == length(sys["rho,kg/m3"]) == 200
    @test nanmean(sys["rho,kg/m3"]) ≈ 2849.430250000001 rtol=0.01

    # Query seismic properties on diagonal line across P-T space
    seismic = perplex_query_seismic(scratchdir, P_range, T_range, index=1, npoints=200)
    @test isa(seismic, Dict) && !isempty(seismic)
    @test haskey(seismic,"T(K)") && !isempty(seismic["T(K)"]) && all(extrema(seismic["T(K)"]) .≈ T_range)
    @test length(seismic["T(K)"]) == length(seismic["rho,kg/m3"])  == 200
    @test nanmean(seismic["rho,kg/m3"]) ≈ 2908.4681500000006 rtol=0.01

    # Query properties on a manually-specified diagonal P-T line
    P = range(first(P_range), last(P_range), length=16)
    T = range(first(T_range), last(T_range), length=16)

    modes = perplex_query_modes(scratchdir, P, T, index=1)
    @test isa(modes, Dict) && !isempty(modes)
    @test haskey(modes,"T(K)") && all(isapprox.(modes["T(K)"], T, atol=0.1))
    @test length(modes["Opx(HP)"]) == 16
    @test modes["Opx(HP)"] ≈ [NaN, NaN, NaN, NaN, NaN, NaN, NaN, 5.14854, 9.1865, 10.3581, 10.362, 10.3658, 10.3688, 10.3719, 13.7688, 14.572] nans=true rtol=0.01

    phase = perplex_query_phase(scratchdir, "Opx(HP)", P, T, index=1)
    @test isa(phase, Dict) && !isempty(phase)
    @test haskey(phase,"T(K)") && all(isapprox.(phase["T(K)"], T, atol=0.1))
    @test haskey(phase,"SIO2") && length(phase["SIO2"]) == 16
    @test phase["SIO2"] ≈ [NaN, NaN, NaN, NaN, NaN, NaN, NaN, 49.019009803801964, 48.99169510083049, 49.01006569295402, 49.04348038260784, 49.07787546106227, 49.110609822121965, 49.14480982896197, 49.31759013648197, 49.55400991080199] nans=true rtol=0.01

    sys = perplex_query_system(scratchdir, P, T, index=1)
    @test isa(sys, Dict) && !isempty(sys)
    @test haskey(sys,"T(K)") && all(isapprox.(sys["T(K)"], T, atol=0.1))
    @test haskey(sys, "rho,kg/m3") && length(sys["rho,kg/m3"]) == 16
    @test sys["rho,kg/m3"] ≈ [2875.21, 2875.21, 2875.21, 2875.21, 2875.2, 2874.94, 2874.93, 2833.74, 2825.41, 2824.65, 2826.44, 2828.01, 2829.42, 2830.68, 2840.64, 2844.03] nans=true rtol=0.01

    seismic = perplex_query_seismic(scratchdir, P, T, index=1)
    @test isa(seismic, Dict) && !isempty(seismic)
    @test haskey(seismic,"T(K)") && all(isapprox.(sys["T(K)"], T, atol=0.1))
    @test haskey(seismic, "rho,kg/m3") && length(sys["rho,kg/m3"]) == 16
    @test seismic["rho,kg/m3"] ≈ [2875.21, 2875.21, 2875.21, 2875.21, 2875.2, 2875.34, 2875.32, 2905.4, 2927.22, 2933.56, 2933.46, 2933.36, 2933.26, 2933.15, 2956.4, 2962.18] nans=true atol=0.1

    ## --- # # # # # # # # Isobaric example with more advanced models # # # # # # # # #

    # Kelemen (2014) primitive continental basalt
    elements =       [ "SiO2", "TiO2", "Al2O3",  "FeO",  "MgO",  "CaO", "Na2O",  "K2O",  "H2O",  "CO2",  "Mn",  "P",  "La",  "Ce", "Pr",  "Nd", "Sm", "Eu", "Gd", "Tb", "Dy", "Ho", "Er", "Tm", "Yb", "Lu",  "Sc",    "V",   "Cr", "Co",   "Ni",  "Cu", "Zn",  "Rb",  "Sr",   "Y", "Zr", "Nb", "Cs",   "Ba", "Hf", "Ta", "Pb", "Th",  "U",]
    concentrations = [50.0956, 0.9564, 15.3224, 8.5103, 9.2520, 9.6912, 2.5472, 0.8588, 2.0000, 0.6000, 1316., 960., 11.85, 25.87, 2.85, 14.88, 3.43, 1.07, 3.55, 0.51, 3.32, 0.68, 1.95, 0.29, 1.82, 0.28, 32.51, 246.59, 397.96, 41.2, 158.74, 91.91, 81.3, 18.63, 425.7, 18.69, 92.7, 6.23, 0.71, 295.04, 2.14, 0.45, 3.36, 2.03, 0.53,]
    composition = NCKFMASHTOCO2trace{Float64}(concentrations, elements)

    P = 5000 # Pressure, bar
    T_range = (750+273.15, 1250+273.15) # Temperature range, Kelvin
    solution_phases = "melt(HGPH)\nFsp(HGP)\nlAb(HGP)\nGt(HGP)\nO(HGP)\nOpx(HGP)\nCpx(HGP)\nIlm(WPH)\n"

    # Configure (run build and vertex)
    @info "perplex_configure_isobar:"
    @time perplex_configure_isobar(scratchdir, composition, P, T_range; solution_phases, index=3, npoints=32)

    # Test perplextrace_query
    results = perplextrace_query(scratchdir, composition, index=3, npoints=8, export_melt_parameters=false)
    @test results isa Dict{String, Union{Vector{Float64}, Vector{String}}}
    expected = Dict{String, Union{Vector{Float64}, Vector{String}}}("Melt_Cs" => [3.586478201632528, 3.2174967948872033, 2.670504993700534, 2.0175484737090597, 1.3394326373792274, 0.8295547476768794, 0.7154951613348869, 0.71], "phl" => [6.398824153307638, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_CaO" => [2.6609300798279025, 3.069411227764491, 3.7405411969731834, 5.132378870876649, 7.266098982746142, 9.67852203248963, 9.798792743661966, 9.714250971425097], "Melt_La" => [88.51427219949275, 45.63959274017174, 40.39512787081594, 31.609087445056662, 21.702322944677505, 13.785212537736115, 11.942320944698317, 11.85], "Melt_Co" => [30.747003922286588, 28.120756564750682, 25.503873559876798, 26.726724523638786, 30.558521677968407, 34.069099367568825, 40.02125026299269, 41.2], "Fsp(HGP)" => [44.450502458296086, 34.231557933095715, 31.257652406334994, 26.78055947801182, 18.664716278923667, 3.823742038511796, 0.0, 0.0], "Melt_Sm" => [15.797355273705067, 10.086532734287225, 9.349279707330261, 7.69460716831874, 5.688031043197227, 3.9154556808431216, 3.456591735167713, 3.43], "Melt_Nd" => [79.19411787356088, 48.046730917178046, 44.49822567886913, 35.90907227004563, 25.742715884303816, 17.12501577168226, 14.99570332084084, 14.88], "Fsp(HGP)_anorthite" => [32.475229134523154, 27.744975282603242, 26.056087906323025, 22.957300355226312, 16.4598265740136, 3.476126154676139, NaN, NaN], "Melt_Th" => [39.747465719288364, 10.180677014610955, 8.267038205997823, 6.076333667946066, 3.926779789793307, 2.3801293129710945, 2.0458105252576995, 2.03], "CO2" => [0.5945261089399302, 0.5488135683607758, 0.524324463961817, 0.4854929863263197, 0.4159121461680162, 0.28980041935463613, 0.1737955962773984, 0.07132446565798997], "Melt_Rb" => [139.79733507253644, 87.9062503340476, 71.67849223870527, 53.805592750061685, 35.51123785720215, 21.8021763583793, 18.774905534621382, 18.63], "Melt_Tb" => [2.048052164751279, 1.357975948736674, 1.2512139881591153, 1.0508339604425267, 0.8051012616562258, 0.576404157285137, 0.5139213274370946, 0.51], "Melt_Ta" => [4.773972027729965, 1.8882409410263605, 1.563048896504402, 1.223932830260097, 0.8485064451924154, 0.5262733911194847, 0.45346702124330857, 0.45], "Ilm(WPH)" => [1.5576962883206913, 1.3640757024602723, 1.2018675880620904, 0.902487255191834, 0.2756210159795141, 0.0, 0.0, 0.0], "apatite" => [0.3340842664444306, 0.1767144908161985, 0.020357177037806262, NaN, NaN, NaN, NaN, NaN], "Melt_Hf" => [6.969383333471331, 8.194757300498344, 6.8665112767994705, 5.424919535559993, 3.8250652161457035, 2.475747688189539, 2.156567141914103, 2.14], "Melt_Gd" => [15.838548827202914, 10.101485358408285, 9.24595136764329, 7.677740377147993, 5.769833196542468, 4.0360275291672725, 3.577466417087477, 3.55], "all_melts" => [2.279637553940115, 17.841212926265026, 22.84304339515121, 31.85708722478535, 50.42619623585691, 84.79075525052974, 99.05248159831808, 99.928675534342], "melt(HGPH)" => [2.279637553940115, 17.841212926265026, 22.84304339515121, 31.85708722478535, 50.42619623585691, 84.79075525052974, 99.05248159831808, 99.928675534342], "Melt_Sr" => [188.46490620348737, 266.7630079833251, 294.40573485472726, 327.55842493139505, 371.8027142573742, 437.97462809033914, 429.016944005647, 425.7], "Melt_FeO" => [1.2893300386799014, 2.0608008243203293, 3.703161185011579, 6.111788655406496, 8.391188825233563, 8.486911782251475, 8.491422377598264, 8.530540853054086], "Melt_CO2" => [0.24641600739248024, 0.28962711585084633, 0.3353581073145943, 0.36257192023417756, 0.36704394861384715, 0.3670190770740062, 0.4312891207609537, 0.5300520530052053], "Fsp(HGP)_orthoclase" => [0.06140933807480195, 0.0381586419676194, 0.028091023266961383, 0.018116473531890213, 0.008542433627222668, 0.00108363756225604, NaN, NaN], "Melt_Al2O3" => [20.41090061232702, 20.21140808456323, 19.120406118529957, 17.72929609955486, 16.503197689552323, 16.24870341222772, 15.494704338517213, 15.358801535880154], "Cpx(HGP)" => [20.6930572831058, 20.504257161059375, 20.59022239092929, 19.79315941567233, 15.811875542301177, 4.269512556954739, 0.0, 0.0], "zircon" => [0.01260875242908364, NaN, NaN, NaN, NaN, NaN, NaN, NaN], "Melt_MgO" => [0.7710590231317708, 1.3487405394962158, 2.181990698237023, 3.4848192333397687, 5.230319267755302, 7.209231513938619, 9.002832520793104, 9.274010927401093], "Fsp(HGP)_albite" => [11.913863985698132, 6.448424008524857, 5.173473476745006, 3.8051426492536202, 2.196347271282845, 0.3465322462734017, NaN, NaN], "Melt_Sc" => [39.917263482707504, 32.49423050089901, 28.62355941252699, 28.337956463360463, 29.985570373586214, 31.94695328747618, 32.70618381384837, 32.51], "Melt_Eu" => [1.2114935504825648, 1.5051027567766566, 1.5679569059285077, 1.5671748258989846, 1.445324380455105, 1.193288004403832, 1.0783181719386377, 1.07], "Melt_Dy" => [13.189784149459609, 8.738693751628501, 7.9903396360563885, 6.733592762029412, 5.194611748287512, 3.745331509568577, 3.3455415994650406, 3.32], "Melt_Nb" => [91.56198774720343, 28.91114273528238, 23.446315623899608, 17.841777445832733, 11.985158931991064, 7.306531733437297, 6.27845928463108, 6.23], "all_fluids" => [1.952200294763204, 0.5488135683607758, 0.524324463961817, 0.4854929863263197, 0.4159121461680162, 0.28980041935463613, 0.1737955962773984, 0.07132446565798997], "Melt_Zr" => [371.03100107208974, 396.202423392341, 327.8920594049946, 251.54462673987152, 171.15157468808317, 107.83203017829968, 93.41698953044991, 92.7], "Melt_Yb" => [8.166503164218824, 5.278966754219838, 4.615973900321523, 3.849555683759738, 2.932123724875906, 2.0629087331746283, 1.8338537551284106, 1.82], "Melt_Ce" => [193.18360137019803, 99.26405472907678, 89.21589323085936, 69.47099715050152, 47.49630248672738, 30.0897985075987, 26.071392479890452, 25.87], "Melt_Na2O" => [7.154550214636507, 6.374772549909019, 6.106941954221425, 5.272948839951255, 4.034599435156079, 2.9081706107158287, 2.5758407212354015, 2.5532602553260255], "Melt_K2O" => [3.8781601163448034, 4.5700418280167305, 3.6345811630659726, 2.6353894202143278, 1.6842097642106328, 1.0124902126229447, 0.8684582431683079, 0.8608430860843087], "Melt_Ba" => [293.1374380765039, 434.8356831779281, 458.50408979116145, 463.33078111399925, 421.9479203321944, 333.7365795119849, 297.3389870147088, 295.04], "Melt_Lu" => [1.152180565567632, 0.7759308013885321, 0.6889302446240295, 0.5782493647165114, 0.4434231344432046, 0.3162102392587867, 0.28211088623647307, 0.28], "Melt_P" => [1549.6850659862916, 2262.822995261286, 3199.0512110529494, 2627.3405694211597, 1790.194008088773, 1119.6571207110599, 967.222996828141, 960.0], "H2O" => [1.357674185823274, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], "Melt_SiO2" => [49.159501474785046, 50.38012015204805, 51.64451652624529, 51.96988856662452, 51.222692828823, 50.63501063335224, 50.34701409716394, 50.2148050214805], "Melt_Cr" => [150.87836325576356, 153.748019111273, 143.36345036659065, 152.3691775191981, 192.21475643652528, 304.07390611241846, 397.31610967491196, 397.96], "Opx(HGP)" => [20.30110651588041, 21.4798776471744, 19.63072764349442, 16.084101860863292, 10.433938701977398, 3.4466656354202168, 0.0, 0.0], "elements" => ["P(bar)", "T(C)", "all_melts", "all_fluids", "all_solids", "melt(HGPH)", "apatite", "CO2", "Cpx(HGP)", "Fsp(HGP)", "Fsp(HGP)_albite", "Fsp(HGP)_anorthite", "Fsp(HGP)_orthoclase", "H2O", "Ilm(WPH)", "O(HGP)", "Opx(HGP)", "phl", "zircon", "Melt_SiO2", "Melt_TiO2", "Melt_Al2O3", "Melt_FeO", "Melt_MgO", "Melt_CaO", "Melt_Na2O", "Melt_K2O", "Melt_H2O", "Melt_CO2", "Melt_P", "Melt_Rb", "Melt_Cs", "Melt_Sr", "Melt_Ba", "Melt_Sc", "Melt_V", "Melt_Cr", "Melt_Mn", "Melt_Co", "Melt_Ni", "Melt_La", "Melt_Ce", "Melt_Nd", "Melt_Sm", "Melt_Eu", "Melt_Gd", "Melt_Tb", "Melt_Dy", "Melt_Yb", "Melt_Lu", "Melt_Y", "Melt_Zr", "Melt_Hf", "Melt_Nb", "Melt_Ta", "Melt_Th", "Melt_U"], "all_solids" => [95.74350310917396, 81.6099735053742, 76.63263214088697, 67.65741978888832, 49.157891617975096, 14.919444330115633, 0.7737228054045144, 0.0], "Melt_TiO2" => [0.3845520115365604, 0.5765732306292922, 0.7703502465120788, 1.012439777263249, 1.3278598140996258, 1.0912702291667482, 0.9671552708034756, 0.9586750958675097], "Melt_U" => [9.681600980576906, 2.6837855549219873, 2.1682039420719486, 1.5905705218942399, 1.026516031163861, 0.6215904402096556, 0.534131549331801, 0.53], "Melt_Mn" => [2189.5302057046474, 1642.7273128451754, 1478.2952067937074, 1460.158446236007, 1469.2861519576634, 1336.2084215221469, 1315.1209763939894, 1316.0], "P(bar)" => [5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0, 5000.0], "O(HGP)" => [1.9956233913898032, 3.8534905707682343, 3.931804935028362, 4.097111779149036, 3.971740078793336, 3.37952409922888, 0.7737228054045144, 0.0], "Melt_H2O" => [14.044600421338014, 11.118504447401778, 8.762152803888897, 6.288478616534705, 3.9727894438094773, 2.3626704961608045, 2.0224905662973582, 2.0047602004760203], "Melt_V" => [62.35189200364231, 99.8750059089643, 230.60141224506472, 272.8732226651955, 269.9833823755049, 256.491227320877, 248.29291451283524, 246.59], "Melt_Ni" => [21.67546422447051, 54.26174468997219, 51.95887930446584, 53.45042928710507, 61.91535518985782, 90.80148012870727, 144.29350135207747, 158.74], "T(C)" => [750.0, 821.43, 892.86, 964.2900000000001, 1035.71, 1107.1399999999999, 1178.5700000000002, 1250.0], "Melt_Y" => [69.38518941208328, 46.952314046213544, 42.947222512064975, 36.60792992239784, 28.69608361564124, 20.990431715887386, 18.832762424915536, 18.69])
    for k in expected["elements"]
        @test haskey(results,k)
        if haskey(results, k)
            @test results[k] ≈ expected[k] nans=true rtol=0.01
        end
    end
    # @info results

    results = perplextrace_query(scratchdir, composition; index=3, npoints=16, 
        export_bulk_kds=true, 
        export_mineral_kds=true, 
        export_mineral_compositions=true,
    )
    @test results isa Dict{String, Union{Vector{Float64}, Vector{String}}}
    @test results["zircon"] ≈ [0.01260875242908364, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]  nans=true atol=0.1
    @test results["Melt_TiO2"] ≈ [0.3845520115365604, 0.4901310686183496, 0.5649919209011312, 0.6494052013156122, 0.7419696067561085, 0.8450781267617189, 0.9593759328436849, 1.0877893146927318, 1.2335094942611076, 1.4051201264608117, 1.2409690320441547, 1.0339308581626123, 0.9871016742564476, 0.9638395180802412, 0.9591408369460578, 0.9586750958675097]  nans=true atol=0.1
    @test results["Zircon_Ti"] ≈ [10.46178465494583, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]   nans=true atol=0.1
    @test results["Melt_Yb"] ≈ [8.15070021365173, 5.7081238624038315, 5.311049851283383, 5.009203580309242, 4.689459371088137, 4.388922160281339, 4.020077410321277, 3.611228881382463, 3.1713439432410664, 2.7369569402315936, 2.3322046194272885, 1.9593336069360097, 1.869928302930978, 1.8278523801972235, 1.82, 1.82]  nans=true atol=0.1
    @test results["O(HGP)_Yb"] ≈ [0.2380671314000978, 0.1694370044600156, 0.16167790170801283, 0.15620035139164637, 0.15083902601269172, 0.14058627417045713, 0.1269788926841008, 0.11172648784434838, 0.09558964361496733, 0.07708584941799299, 0.06378019696414836, 0.051696439946184766, 0.04824226565090334, 0.04576417765406641, NaN, NaN]  nans=true atol=0.1
    @test results["Zircon_Yb"] ≈ [1603.1629972552423, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN, NaN]  nans=true atol=0.1
    @test results["D_Zircon_Yb"] ≈ [196.30960339052226, 166.24028382926173, 142.70126869746622, 124.85361624887183, 109.4716876507253, 96.06451187884979, 84.90492654441113, 75.53496573371594, 67.60421447040335, 60.4297919833154, 54.67204796938198, 49.69963357540342, 45.38296818153654, 41.06776992078418, 37.80254986310544, 34.924184631349505]  nans=true atol=0.1

    results = perplextrace_query(scratchdir, composition; index=3, npoints=16, 
        export_bulk_kds=true, 
        export_mineral_kds=true, 
        export_mineral_compositions=true,
        require_phase_for_export="zircon",
    )
    @test results["Melt_TiO2"] ≈ [0.3845520115365604]  nans=true atol=0.1
    @test results["Zircon_Ti"] ≈ [10.46178465494583,]  nans=true atol=0.1
    @test results["Melt_Yb"] ≈ [8.15070021365173,]  nans=true atol=0.1
    @test results["O(HGP)_Yb"] ≈ [0.2380671314000978,]  nans=true atol=0.1
    @test results["Zircon_Yb"] ≈ [1603.1629972552423]  nans=true atol=0.1
    @test results["D_Zircon_Yb"] ≈ [196.30960339052226,]  nans=true atol=0.1
    @test results["D_O(HGP)_Yb"] ≈ [0.024560827788128785,]  nans=true atol=0.1
    @test results["D_Yb"] ≈ [0.204876433273611,]  nans=true atol=0.1
    @test results["T(C)"] ≈ [750.0,]  nans=true atol=0.1

    results = perplextrace_query(scratchdir, composition; index=3, npoints=16, 
        require_phase_for_export=("Cpx(HGP)","melt(HGPH)"),
    )
    @test results["Cpx(HGP)"] ≈ [20.6930572831058, 20.409903298567315, 20.488133247900755, 20.580295395617547, 20.605119540173952, 20.490828709421166, 20.097573427506514, 19.195178392515373, 17.405614031973773, 14.26179467402758, 9.144250428812342, 2.0050599032342964]  nans=true atol=0.1
    @test results["melt(HGPH)"] ≈ [2.2704876357771635, 15.296254179073816, 17.592452040250162, 19.520690321274277, 21.99975184558435, 25.209865519470878, 29.524627711038114, 35.5580530365805, 44.09895674595682, 56.012860270168595, 71.18805760128726, 91.04119666736531]  nans=true atol=0.1

    # Test that `perplextrace_query_melt` gives equivalent results for melt composition
    results = perplextrace_query_melt(scratchdir, composition; index=3, npoints=16)
    @test results isa Dict{String, Union{Vector{Float64}, Vector{String}}}
    @test results["TiO2"] ≈ [0.3845520115365604, 0.4901310686183496, 0.5649919209011312, 0.6494052013156122, 0.7419696067561085, 0.8450781267617189, 0.9593759328436849, 1.0877893146927318, 1.2335094942611076, 1.4051201264608117, 1.2409690320441547, 1.0339308581626123, 0.9871016742564476, 0.9638395180802412, 0.9591408369460578, 0.9586750958675097]  nans=true atol=0.1
    @test results["Yb"] ≈ [8.15070021365173, 5.7081238624038315, 5.311049851283383, 5.009203580309242, 4.689459371088137, 4.388922160281339, 4.020077410321277, 3.611228881382463, 3.1713439432410664, 2.7369569402315936, 2.3322046194272885, 1.9593336069360097, 1.869928302930978, 1.8278523801972235, 1.82, 1.82]  nans=true atol=0.1

    ## --- End of PerpleX tests
end

